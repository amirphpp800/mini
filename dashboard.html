<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard — Pro TooLs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&family=Vazirmatn:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="Logo/Logo.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="public/styles.css" />
  <style>
    .dashboard-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .dashboard-card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(14px);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
    }
    .home-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #22c55e;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .home-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.45);
    }
    .row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .row input, .row button {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.5);
      color: white;
      font-weight: 600;
    }
    .row button {
      background: #fff;
      color: #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .row button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    .danger-btn {
      background: #ff3b30 !important;
      color: #fff !important;
    }
    .alt-btn {
      background: transparent !important;
      border: 1px solid rgba(255,255,255,0.3) !important;
    }
    .muted {
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
    }
    .persian-text {
      font-family: 'Vazirmatn', 'Poppins', sans-serif;
      direction: rtl;
    }
    .hist-row {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.5rem;
    }
    .hist-header {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .hist-geo-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .hist-geo-card {
      background: rgba(0,0,0,0.3);
      padding: 0.5rem;
      border-radius: 8px;
      font-size: 0.8rem;
    }
    .geo-ip {
      font-weight: 600;
      color: #7fd1ff;
    }
    .geo-meta {
      color: rgba(255,255,255,0.7);
      margin-top: 0.2rem;
    }
    .country-header {
      font-size: 1rem !important;
    }
    .country-header strong {
      font-size: 1rem !important;
      font-weight: 600 !important;
      line-height: 1.2 !important;
    }
  </style>
</head>
<body>
  <canvas id="bg-net"></canvas>
  
  <!-- Home Button -->
  <button class="home-btn" onclick="window.location.href='index.html'" title="بازگشت به خانه">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
      <polyline points="9,22 9,12 15,12 15,22"/>
    </svg>
  </button>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="brand">
        <img class="brand-logo" src="Logo/Logo.svg" alt="Pro TooLs logo" />
        <span class="brand-name">Dashboard</span>
      </div>
    </div>

    <!-- Status Card -->
    <div class="dashboard-card">
      <h2>Account Status</h2>
      <div class="status-line" id="accStatus">Checking status...</div>
      
      <div class="row" id="u_balance_row" style="display:none">
        <div class="muted">Balance: <span id="u_balance_value">$0.00</span></div>
      </div>
      
      <div class="row" id="u_id_row" style="display:none">
        <div class="muted">Your ID: <span id="u_id_value"></span></div>
      </div>
      
      <div class="row" id="u_logged" style="display:none">
        <span>Logged in</span>
        <button id="u_logout" class="danger-btn">Logout</button>
      </div>
    </div>

    <!-- Gift Code Card -->
    <div class="dashboard-card" id="u_gift_card" style="display:none">
      <h2>Gift Code</h2>
      <div class="row" style="gap:.5rem; align-items:center;">
        <input type="text" id="u_gift_code" placeholder="Gift code" style="flex:1;" />
        <button id="u_gift_redeem">Redeem</button>
      </div>
    </div>

    <!-- Password Management Button -->
    <div class="dashboard-card" id="u_setpwd_card" style="display:none">
      <h2>Security Settings</h2>
      <div class="row" style="justify-content:center;">
        <button id="u_open_setpwd" class="primary-btn">
          <span class="btn-ico" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="m7 11V7a5 5 0 0 1 10 0v4"/></svg>
          </span>
          <span id="u_setpwd_btn_text">Set Password</span>
        </button>
      </div>
      <div id="u_setpwd_notice" class="muted persian-text" style="display:none; margin-top:1rem; padding:0.75rem; background:rgba(255,193,7,0.15); border:1px solid rgba(255,193,7,0.3); border-radius:8px; color:#ffc107;">
        برای امنیت حساب کاربری، تنظیم رمز عبور الزامی است. لطفاً یک رمز عبور قوی (حداقل ۶ کاراکتر) انتخاب کنید.
      </div>
    </div>

    <!-- Address History Card -->
    <div class="dashboard-card" id="u_history_wrap" style="display:none">
      <h2>Your Fetched Addresses</h2>
      <p class="muted persian-text">از طریق داشبورد حساب کاربری می‌توانید به آدرس‌های دریافت‌شده خود دسترسی داشته باشید و دوباره آن‌ها را مشاهده یا کپی کنید.</p>
      <div id="u_history" style="display:flex;flex-direction:column;gap:.5rem;margin-top:1rem;"></div>
    </div>

    <!-- Login Card (if not logged in) -->
    <div class="dashboard-card" id="login_card">
      <h2>Login Required</h2>
      <p class="muted">Please login to access your dashboard.</p>
      <div class="row" style="justify-content:center;margin-top:1rem;">
        <button onclick="window.location.href='login.html'">Go to Login</button>
      </div>
    </div>
  </div>

  <!-- Global glassy error modal -->
  <div class="alert-overlay" id="alertOverlay"></div>
  <div class="alert-container" id="alertContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
      <div class="hdr">
        <div class="ttl" id="alertTitle">خطا</div>
        <button class="btn-close" id="alertX">×</button>
      </div>
      <div class="msg" id="alertMsg"></div>
      <div class="actions">
        <button class="btn-close" id="alertOk">OK</button>
      </div>
    </div>
  </div>

  <!-- Confirm modal -->
  <div class="alert-overlay" id="confirmOverlay"></div>
  <div class="alert-container" id="confirmContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="hdr">
        <div class="ttl" id="confirmTitle">تایید</div>
        <button class="btn-close" id="confirmX">×</button>
      </div>
      <div class="msg" id="confirmMsg"></div>
      <div class="actions">
        <button id="confirmNo">Cancel</button>
        <button id="confirmYes" class="primary-btn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="alert-overlay" id="passwordOverlay"></div>
  <div class="alert-container" id="passwordContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="passwordTitle" style="max-width:500px;">
      <div class="hdr">
        <div class="ttl" id="passwordTitle">Set Password</div>
        <button class="btn-close" id="passwordX">×</button>
      </div>
      <div class="msg" style="padding:0;">
        <div style="margin-bottom:1rem;">
          <input type="password" id="modal_setpwd_1" placeholder="New password (min 6)" style="width:100%; margin-bottom:0.5rem;" />
          <input type="password" id="modal_setpwd_2" placeholder="Repeat new password" style="width:100%;" />
        </div>
        <div id="modal_setpwd_notice" class="muted persian-text" style="display:none; margin-bottom:1rem; padding:0.75rem; background:rgba(255,193,7,0.15); border:1px solid rgba(255,193,7,0.3); border-radius:8px; color:#ffc107;">
          برای امنیت حساب کاربری، تنظیم رمز عبور الزامی است. لطفاً یک رمز عبور قوی (حداقل ۶ کاراکتر) انتخاب کنید.
        </div>
      </div>
      <div class="actions">
        <button id="passwordCancel">Cancel</button>
        <button id="passwordSave" class="primary-btn">Save Password</button>
      </div>
    </div>
  </div>

  <script>
    // Error/Message modal helper
    (function(){
      const overlay = document.getElementById('alertOverlay');
      const container = document.getElementById('alertContainer');
      const titleEl = document.getElementById('alertTitle');
      const msgEl = document.getElementById('alertMsg');
      const okBtn = document.getElementById('alertOk');
      const xBtn = document.getElementById('alertX');
      function close(){ overlay.classList.remove('active'); container.classList.remove('active'); }
      function open(title, message, asHtml){
        titleEl.textContent = title || 'پیام';
        if(asHtml){ msgEl.innerHTML = message || ''; }
        else { msgEl.textContent = message || ''; }
        overlay.classList.add('active');
        container.classList.add('active');
      }
      function showError(message, title){ open(title || 'خطا', message, false); }
      function showMessage(message, title){
        const html = String(message||'').replace(/\n/g,'<br>');
        open(title || 'پیام', html, true);
      }
      okBtn.addEventListener('click', close);
      xBtn.addEventListener('click', close);
      overlay.addEventListener('click', close);
      window.showError = showError;
      window.showMessage = showMessage;
    })();

    // Confirm modal helper
    (function(){
      const overlay = document.getElementById('confirmOverlay');
      const container = document.getElementById('confirmContainer');
      const titleEl = document.getElementById('confirmTitle');
      const msgEl = document.getElementById('confirmMsg');
      const yesBtn = document.getElementById('confirmYes');
      const noBtn = document.getElementById('confirmNo');
      const xBtn = document.getElementById('confirmX');

      let resolver = null;
      function close(){ overlay.classList.remove('active'); container.classList.remove('active'); }
      function open(message, title){
        titleEl.textContent = title || 'تایید';
        msgEl.textContent = message || '';
        overlay.classList.add('active');
        container.classList.add('active');
      }
      function resolve(val){ if(resolver){ const r=resolver; resolver=null; r(val); } close(); }
      if(yesBtn) yesBtn.onclick = ()=> resolve(true);
      if(noBtn) noBtn.onclick = ()=> resolve(false);
      if(xBtn) xBtn.onclick = ()=> resolve(false);
      if(overlay) overlay.onclick = ()=> resolve(false);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay && overlay.classList.contains('active')) resolve(false); });

      function showConfirm(message, title){
        return new Promise((resolveFn)=>{ resolver = resolveFn; open(message, title); });
      }
      window.showConfirm = showConfirm;
    })();

    // Password modal helper
    (function(){
      const overlay = document.getElementById('passwordOverlay');
      const container = document.getElementById('passwordContainer');
      const titleEl = document.getElementById('passwordTitle');
      const noticeEl = document.getElementById('modal_setpwd_notice');
      const input1 = document.getElementById('modal_setpwd_1');
      const input2 = document.getElementById('modal_setpwd_2');
      const saveBtn = document.getElementById('passwordSave');
      const cancelBtn = document.getElementById('passwordCancel');
      const xBtn = document.getElementById('passwordX');

      function close(){ 
        overlay.classList.remove('active'); 
        container.classList.remove('active'); 
        if(input1) input1.value = '';
        if(input2) input2.value = '';
      }
      
      function open(isRequired = false){
        if(titleEl) titleEl.textContent = isRequired ? 'Set Password (Required)' : 'Change Password';
        if(noticeEl) noticeEl.style.display = isRequired ? 'block' : 'none';
        if(cancelBtn) cancelBtn.style.display = isRequired ? 'none' : 'inline-block';
        overlay.classList.add('active');
        container.classList.add('active');
        if(input1) input1.focus();
      }

      if(cancelBtn) cancelBtn.onclick = close;
      if(xBtn) xBtn.onclick = close;
      if(overlay) overlay.onclick = (e) => { if(e.target === overlay) close(); };
      
      window.openPasswordModal = open;
      window.closePasswordModal = close;
    })();

    // Dashboard Logic
    (function(){
      const isLocal = /^(localhost|127\.0\.0\.1)/.test(location.hostname);
      const statusEl = document.getElementById('accStatus');
      const balRow = document.getElementById('u_balance_row');
      const balVal = document.getElementById('u_balance_value');
      const loggedRow = document.getElementById('u_logged');
      const logoutBtn = document.getElementById('u_logout');
      const histWrap = document.getElementById('u_history_wrap');
      const histList = document.getElementById('u_history');
      const idRow = document.getElementById('u_id_row');
      const idVal = document.getElementById('u_id_value');
      const loginCard = document.getElementById('login_card');
      const giftCard = document.getElementById('u_gift_card');
      const setpwdCard = document.getElementById('u_setpwd_card');

      async function loadMe(session){
        if(!session) return;
        try{
          const r = await fetch('/auth/me', { headers:{ 'Authorization': `Bearer ${session}` } });
          if(r.ok){
            const { chat_id } = await r.json();
            if(idVal) idVal.textContent = chat_id || '';
          } else {
            if(idVal) idVal.textContent = '';
          }
        }catch(_){ if(idVal) idVal.textContent=''; }
        
        // Check if user has password set
        try{
          const rp = await fetch('/auth/has-password', { headers:{ 'Authorization': `Bearer ${session}` } });
          if(rp.ok){
            const { hasPassword } = await rp.json();
            const btnText = document.getElementById('u_setpwd_btn_text');
            const noticeEl = document.getElementById('u_setpwd_notice');
            const setpwdCard = document.getElementById('u_setpwd_card');
            
            if(!hasPassword){
              // Force password setup
              if(btnText) btnText.textContent = 'Set Password (Required)';
              if(noticeEl) noticeEl.style.display = 'block';
              if(setpwdCard) {
                setpwdCard.style.display = 'block';
                setpwdCard.style.order = '-1'; // Show at top
              }
              
              // Hide other cards until password is set
              const giftCard = document.getElementById('u_gift_card');
              const histWrap = document.getElementById('u_history_wrap');
              if(giftCard) giftCard.style.display = 'none';
              if(histWrap) histWrap.style.display = 'none';
              
              // Auto-open modal for required password
              setTimeout(() => {
                if(window.openPasswordModal) window.openPasswordModal(true);
              }, 500);
            } else {
              // Password exists, normal behavior
              if(btnText) btnText.textContent = 'Change Password';
              if(noticeEl) noticeEl.style.display = 'none';
            }
          }
        }catch(_){}
        
        // Load balance
        try{
          const rb = await fetch('/user/balance', { headers:{ 'Authorization': `Bearer ${session}` } });
          if(rb.ok){
            const { balance } = await rb.json();
            if(balVal) balVal.textContent = `$${balance}`;
            if(balRow) balRow.style.display='flex';
          } else {
            if(balRow) balRow.style.display='none';
          }
        }catch(_e){ if(balRow) balRow.style.display='none'; }
      }

      async function renderDashboard(){
        const ses = localStorage.getItem('userSession');
        if(ses){
          loginCard.style.display='none';
          loggedRow.style.display='flex';
          histWrap.style.display='block';
          giftCard.style.display='block';
          setpwdCard.style.display='block';
          if(idRow) idRow.style.display='flex';
          await loadMe(ses);
          renderUserHistory();
        } else {
          loginCard.style.display='block';
          loggedRow.style.display='none';
          histWrap.style.display='none';
          giftCard.style.display='none';
          setpwdCard.style.display='none';
          if(idRow) idRow.style.display='none';
          if(idVal) idVal.textContent = '';
          if(balRow) balRow.style.display='none';
        }
      }

      // Initialize
      (async()=>{
        try{
          if(isLocal){
            statusEl.textContent = 'Local mode';
            statusEl.style.color = '#ffd27a';
          } else {
            const r = await fetch('/status');
            if(r.ok){
              const {kv, bot} = await r.json();
              statusEl.textContent = `KV: ${kv? 'Connected':'Not available'} | Bot token: ${bot? 'Configured':'Missing'}`;
              statusEl.style.color = kv && bot ? '#9cff9c' : '#ffd27a';
            } else {
              statusEl.textContent = 'Unable to read status endpoint';
              statusEl.style.color = '#ffd27a';
            }
          }
        }catch(e){
          statusEl.textContent = 'Status check failed';
          statusEl.style.color = '#ffd27a';
        }
        renderDashboard();
      })();

      // Logout functionality
      logoutBtn.addEventListener('click', async ()=>{
        if(await window.showConfirm('آیا از خروج از حساب اطمینان دارید؟','تایید خروج')){
          localStorage.removeItem('userSession');
          await renderDashboard();
        }
      });

      // Gift redeem functionality
      const giftBtn = document.getElementById('u_gift_redeem');
      if(giftBtn){
        giftBtn.addEventListener('click', async ()=>{
          const codeEl = document.getElementById('u_gift_code');
          const code = (codeEl && codeEl.value || '').trim();
          if(!code){ window.showError('Enter a gift code'); return; }
          const session = localStorage.getItem('userSession');
          if(!session){ window.showError('Please login first'); return; }
          try{
            const r = await fetch('/gift/redeem', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${session}` }, body: JSON.stringify({ code }) });
            if(!r.ok){
              let msg = 'Redeem failed';
              try{ const j = await r.json(); if(j && (j.error||j.message)) msg = j.message || j.error; }catch(_){ }
              window.showError(msg);
              return;
            }
            const j = await r.json();
            window.showMessage(`Gift applied: $${Number(j.amount||0).toFixed(2)}`,'Success');
            // refresh balance
            await loadMe(session);
            if(codeEl) codeEl.value='';
          }catch(e){ window.showError('Network error'); }
        });
      }

      // Open password modal button
      const openSetpwdBtn = document.getElementById('u_open_setpwd');
      if(openSetpwdBtn){
        openSetpwdBtn.addEventListener('click', ()=>{
          const btnText = document.getElementById('u_setpwd_btn_text');
          const isRequired = btnText && btnText.textContent.includes('Required');
          if(window.openPasswordModal) window.openPasswordModal(isRequired);
        });
      }

      // Set password functionality (modal version)
      const modalSaveBtn = document.getElementById('passwordSave');
      if(modalSaveBtn){
        modalSaveBtn.addEventListener('click', async ()=>{
          const a = String(document.getElementById('modal_setpwd_1').value||'');
          const b = String(document.getElementById('modal_setpwd_2').value||'');
          if(a.length<6){ window.showError('Password too short (min 6)'); return; }
          if(a!==b){ window.showError('Passwords do not match'); return; }
          const session = localStorage.getItem('userSession');
          if(!session){ window.showError('Please login first'); return; }
          try{
            const r = await fetch('/auth/set-password',{ method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${session}` }, body: JSON.stringify({ new_password: a }) });
            if(!r.ok){ window.showError('Failed to set password'); return; }
            window.showMessage('Password updated','Success');
            
            // Close modal and reload dashboard
            if(window.closePasswordModal) window.closePasswordModal();
            setTimeout(() => {
              renderDashboard();
            }, 1000);
          }catch(e){ window.showError('Network error'); }
        });
      }

      // Render user address history grouped by country with flags
      async function renderUserHistory(){
        try{
          const arr = JSON.parse(localStorage.getItem('userAddrHistory') || '[]');
          histList.innerHTML = '';
          if(arr.length===0){
            const p = document.createElement('div');
            p.className = 'muted';
            p.textContent = 'No addresses fetched yet.';
            histList.appendChild(p);
            return;
          }
          
          // Helper function to normalize country names
          function normalizeCountryName(country) {
            const normalized = String(country || '').toLowerCase().trim();
            // Normalize England, UK, United Kingdom, Great Britain, GB to England
            if (normalized === 'england' || normalized === 'uk' || normalized === 'united kingdom' || 
                normalized === 'great britain' || normalized === 'gb' || normalized === 'انگلیس') {
              return 'England';
            }
            // Normalize America, USA, United States to a single name
            if (normalized === 'america' || normalized === 'usa' || normalized === 'united states' || normalized === 'united states of america') {
              return 'United States';
            }
            // Return original country name with proper capitalization
            return String(country || '').trim();
          }
          
          // Group addresses by country and collect all IPs
          const countryGroups = new Map();
          const allIps = [];
          
          for(const item of arr){
            const normalizedCountry = normalizeCountryName(item.country);
            if(!countryGroups.has(normalizedCountry)){
              countryGroups.set(normalizedCountry, {
                country: normalizedCountry,
                addresses: [],
                count: 0,
                type: item.type || 'dns'
              });
            }
            const group = countryGroups.get(normalizedCountry);
            group.addresses.push(...(item.addresses || []));
            group.count += item.count || 0;
            allIps.push(...(item.addresses || []));
          }
          
          // Get geolocation for all IPs at once
          let geoResults = [];
          try{
            const session = localStorage.getItem('userSession');
            if(session && allIps.length > 0){
              const geoRes = await fetch('/geo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ips: allIps })
              });
              
              if(geoRes.ok){
                const geoData = await geoRes.json();
                geoResults = geoData.results || [];
              }
            }
          }catch(e){
            console.error('Geo lookup failed:', e);
          }
          
          // Create a map for quick geo lookup
          const geoMap = new Map();
          for(const geo of geoResults){
            if(geo.query) geoMap.set(geo.query, geo);
          }
          
          // Helper function to get country code from geo data or fallback
          function getCountryCode(countryName, addresses){
            // Try to get from geo data first
            for(const addr of addresses){
              const geo = geoMap.get(addr);
              if(geo && geo.countryCode) return geo.countryCode.toLowerCase();
            }
            
            // Fallback mapping for common countries
            const countryCodeMap = {
              'england': 'gb', 'united kingdom': 'gb', 'uk': 'gb', 'great britain': 'gb', 'gb': 'gb', 'انگلیس': 'gb',
              'united states': 'us', 'usa': 'us', 'america': 'us',
              'germany': 'de', 'deutschland': 'de',
              'france': 'fr', 'canada': 'ca', 'australia': 'au',
              'netherlands': 'nl', 'holland': 'nl',
              'turkey': 'tr', 'türkiye': 'tr',
              'china': 'cn', 'japan': 'jp', 'south korea': 'kr',
              'singapore': 'sg', 'hong kong': 'hk',
              'united arab emirates': 'ae', 'uae': 'ae',
              'qatar': 'qa', 'bahrain': 'bh',
              'italy': 'it', 'spain': 'es', 'belgium': 'be',
              'sweden': 'se', 'finland': 'fi', 'denmark': 'dk',
              'switzerland': 'ch', 'austria': 'at', 'norway': 'no',
              'bulgaria': 'bg'
            };
            
            const key = countryName.toLowerCase();
            return countryCodeMap[key] || 'xx'; // xx for unknown
          }
          
          // Separate matching and mismatched addresses
          const matchingCountries = new Map();
          const mismatchedAddresses = [];
          
          for(const [countryName, group] of countryGroups){
            const matchingIPs = [];
            const mismatchedIPs = [];
            
            for(const addr of group.addresses){
              const geo = geoMap.get(addr);
              const geoCountry = geo?.country || '';
              
              // Check if geo country matches the expected country (case insensitive)
              // Also handle England/UK/United Kingdom variations
              const normalizedGeoCountry = normalizeCountryName(geoCountry);
              const normalizedCountryName = normalizeCountryName(countryName);
              
              // Special handling for England/UK variations
              const isEnglandMatch = (
                (normalizedGeoCountry === 'England' && ['United Kingdom', 'UK', 'Great Britain', 'GB'].includes(geoCountry)) ||
                (normalizedCountryName === 'England' && ['United Kingdom', 'UK', 'Great Britain', 'GB'].includes(geoCountry)) ||
                (geoCountry === 'United Kingdom' && normalizedCountryName === 'England')
              );
              
              const isMatch = normalizedGeoCountry === normalizedCountryName ||
                             isEnglandMatch ||
                             normalizedGeoCountry.toLowerCase().includes(normalizedCountryName.toLowerCase()) || 
                             normalizedCountryName.toLowerCase().includes(normalizedGeoCountry.toLowerCase()) ||
                             geoCountry.toLowerCase().includes(countryName.toLowerCase()) || 
                             countryName.toLowerCase().includes(geoCountry.toLowerCase()) ||
                             geoCountry === countryName;
              
              if(isMatch || !geoCountry){
                matchingIPs.push({ ip: addr, geo: geo });
              } else {
                mismatchedIPs.push({ 
                  ip: addr, 
                  geo: geo, 
                  expectedCountry: countryName,
                  actualCountry: geoCountry 
                });
              }
            }
            
            // Only add to matching countries if there are matching IPs
            if(matchingIPs.length > 0){
              matchingCountries.set(countryName, {
                ...group,
                addresses: matchingIPs.map(item => item.ip),
                matchingIPs: matchingIPs,
                count: matchingIPs.length
              });
            }
            
            // Add mismatched IPs to the global mismatched list
            mismatchedAddresses.push(...mismatchedIPs);
          }
          
          // Sort matching countries alphabetically
          const sortedCountries = Array.from(matchingCountries.entries()).sort((a, b) => a[0].localeCompare(b[0]));
          
          // Render each matching country group
          for(const [countryName, group] of sortedCountries){
            const row = document.createElement('div');
            row.className = 'hist-row country-group';
            
            // Country header with flag
            const countryCode = getCountryCode(countryName, group.addresses);
            const header = document.createElement('div');
            header.className = 'hist-header country-header';
            header.style.display = 'flex';
            header.style.alignItems = 'center';
            header.style.gap = '0.75rem';
            
            // Flag
            const flag = document.createElement('img');
            flag.src = `https://flagcdn.com/w40/${countryCode}.png`;
            flag.srcset = `https://flagcdn.com/w80/${countryCode}.png 2x`;
            flag.alt = `${countryName} flag`;
            flag.style.width = '32px';
            flag.style.height = '21px';
            flag.style.borderRadius = '4px';
            flag.style.objectFit = 'cover';
            flag.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            flag.loading = 'lazy';
            
            // Handle flag loading errors
            flag.onerror = function() {
              this.src = `https://flagcdn.com/w40/xx.png`;
              this.onerror = null;
            };
            
            // Country name and count
            const nameDiv = document.createElement('div');
            nameDiv.innerHTML = `<strong>${countryName}</strong> <span class="muted">(${group.count} IPs)</span>`;
            
            header.appendChild(flag);
            header.appendChild(nameDiv);
            
            // Copy button for all country IPs
            const actions = document.createElement('div');
            const copy = document.createElement('button');
            copy.textContent = 'Copy All';
            copy.className = 'copy-btn';
            copy.style.padding = '0.4rem 0.8rem';
            copy.style.borderRadius = '6px';
            copy.style.cursor = 'pointer';
            copy.style.fontSize = '0.85rem';
            copy.addEventListener('click', async ()=>{
              try{ 
                await navigator.clipboard.writeText(group.addresses.join('\n')); 
                window.showMessage('All IPs copied to clipboard'); 
              }catch(_e){ 
                window.showError('Failed to copy'); 
              }
            });
            actions.appendChild(copy);
            
            const top = document.createElement('div');
            top.style.display = 'flex';
            top.style.justifyContent = 'space-between';
            top.style.alignItems = 'center';
            top.appendChild(header);
            top.appendChild(actions);
            row.appendChild(top);
            
            // Render matching IPs for this country
            const geoList = document.createElement('div');
            geoList.className = 'hist-geo-list';
            geoList.style.marginTop = '0.75rem';
            
            // Render IPs that match this country
            for(const {ip, geo} of group.matchingIPs){
              const geoCard = document.createElement('div');
              geoCard.className = 'hist-geo-card';
              
              const ipDiv = document.createElement('div');
              ipDiv.className = 'geo-ip';
              ipDiv.textContent = ip;
              ipDiv.style.cursor = 'pointer';
              ipDiv.title = 'Click to copy';
              
              // Add click to copy functionality
              ipDiv.addEventListener('click', async () => {
                try {
                  await navigator.clipboard.writeText(ip);
                  window.showMessage(`IP ${ip} copied to clipboard`);
                } catch (e) {
                  window.showError('Failed to copy IP');
                }
              });
              
              const metaDiv = document.createElement('div');
              metaDiv.className = 'geo-meta';
              const parts = [];
              if(geo?.country) parts.push(geo.country);
              if(geo?.city) parts.push(geo.city);
              if(geo?.isp) parts.push(geo.isp);
              metaDiv.textContent = parts.join(' • ') || 'No geo data';
              
              geoCard.appendChild(ipDiv);
              geoCard.appendChild(metaDiv);
              geoList.appendChild(geoCard);
            }
            
            row.appendChild(geoList);
            histList.appendChild(row);
          }
          
          // Render mismatched addresses section if any exist
          if(mismatchedAddresses.length > 0){
            const mismatchRow = document.createElement('div');
            mismatchRow.className = 'hist-row country-group';
            mismatchRow.style.borderLeft = '4px solid #fbbf24';
            mismatchRow.style.background = 'rgba(251, 191, 36, 0.1)';
            
            // Mismatched header
            const header = document.createElement('div');
            header.className = 'hist-header country-header';
            header.style.display = 'flex';
            header.style.alignItems = 'center';
            header.style.gap = '0.75rem';
            
            // Warning icon
            const warningIcon = document.createElement('span');
            warningIcon.innerHTML = '⚠️';
            warningIcon.style.fontSize = '24px';
            
            // Header text
            const nameDiv = document.createElement('div');
            nameDiv.className = 'persian-text';
            nameDiv.innerHTML = `<strong style="color:#fbbf24;">آدرس‌های نامطابق</strong> <span class="muted">(${mismatchedAddresses.length} IPs)</span>`;
            nameDiv.style.color = '#fbbf24';
            
            header.appendChild(warningIcon);
            header.appendChild(nameDiv);
            
            // Copy button for mismatched IPs
            const actions = document.createElement('div');
            const copy = document.createElement('button');
            copy.textContent = 'Copy All';
            copy.className = 'copy-btn';
            copy.style.padding = '0.4rem 0.8rem';
            copy.style.borderRadius = '6px';
            copy.style.cursor = 'pointer';
            copy.style.fontSize = '0.85rem';
            copy.style.background = '#fbbf24';
            copy.style.color = '#000';
            copy.addEventListener('click', async ()=>{
              try{ 
                const ips = mismatchedAddresses.map(item => item.ip);
                await navigator.clipboard.writeText(ips.join('\n')); 
                window.showMessage('Mismatched IPs copied to clipboard'); 
              }catch(_e){ 
                window.showError('Failed to copy'); 
              }
            });
            actions.appendChild(copy);
            
            const top = document.createElement('div');
            top.style.display = 'flex';
            top.style.justifyContent = 'space-between';
            top.style.alignItems = 'center';
            top.appendChild(header);
            top.appendChild(actions);
            mismatchRow.appendChild(top);
            
            // Description
            const description = document.createElement('div');
            description.className = 'muted persian-text';
            description.style.marginTop = '0.5rem';
            description.style.fontSize = '0.9rem';
            description.style.color = '#fbbf24';
            description.textContent = 'این آدرس‌ها از کشور مورد انتظار دریافت شده‌اند اما موقعیت جغرافیایی واقعی‌شان متفاوت است:';
            mismatchRow.appendChild(description);
            
            // Render mismatched IPs
            const mismatchList = document.createElement('div');
            mismatchList.className = 'hist-geo-list';
            mismatchList.style.marginTop = '0.75rem';
            
            for(const {ip, geo, expectedCountry, actualCountry} of mismatchedAddresses){
              const geoCard = document.createElement('div');
              geoCard.className = 'hist-geo-card';
              geoCard.style.border = '1px solid rgba(251, 191, 36, 0.3)';
              
              const ipDiv = document.createElement('div');
              ipDiv.className = 'geo-ip';
              ipDiv.textContent = ip;
              ipDiv.style.cursor = 'pointer';
              ipDiv.title = 'Click to copy';
              ipDiv.style.color = '#fbbf24';
              
              // Add click to copy functionality
              ipDiv.addEventListener('click', async () => {
                try {
                  await navigator.clipboard.writeText(ip);
                  window.showMessage(`IP ${ip} copied to clipboard`);
                } catch (e) {
                  window.showError('Failed to copy IP');
                }
              });
              
              const metaDiv = document.createElement('div');
              metaDiv.className = 'geo-meta persian-text';
              metaDiv.innerHTML = `
                <div style="color:#ef4444;">انتظار: ${expectedCountry}</div>
                <div style="color:#22c55e;">واقعی: ${actualCountry}</div>
                ${geo?.city ? `<div>${geo.city}</div>` : ''}
                ${geo?.isp ? `<div>${geo.isp}</div>` : ''}
              `;
              
              geoCard.appendChild(ipDiv);
              geoCard.appendChild(metaDiv);
              mismatchList.appendChild(geoCard);
            }
            
            mismatchRow.appendChild(mismatchList);
            histList.appendChild(mismatchRow);
          }
        }catch(e){ 
          console.error('History render error:', e);
          histList.innerHTML='<div class="muted">Error loading history</div>'; 
        }
      }
    })();
  </script>
  <script src="public/net.js"></script>
</body>
</html>
