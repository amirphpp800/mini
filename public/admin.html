<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pro TooLs â€” Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">
  <link rel="icon" href="../Logo/Logo.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="brand">
      <img class="brand-logo" src="../Logo/Logo.svg" alt="Pro TooLs logo" />
      <span class="brand-name">Pro TooLs</span>
    </div>
    <div class="actions">
      <a href="../index.html" class="admin-btn"><span class="btn-ico" aria-hidden="true">
        <!-- Back arrow icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
      </span>Back to Home</a>
      <button id="logoutBtn" class="danger-btn" style="display:none"><span class="btn-ico" aria-hidden="true">
        <!-- Logout icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </span>Logout</button>
    </div>
  </header>
  <!-- Global glassy error modal -->
  <div class="alert-overlay" id="alertOverlay"></div>
  <div class="alert-container" id="alertContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
      <div class="hdr">
        <div class="ttl" id="alertTitle">Ø®Ø·Ø§</div>
        <button class="btn-close" id="alertX">Ã—</button>
      </div>
      <div class="msg" id="alertMsg"></div>
      <div class="actions">
        <button class="btn-close" id="alertOk">Ø¨Ø§Ø´Ù‡</button>
      </div>
    </div>
  </div>
  <div class="admin-container">
  <div id="loginSection">
    <label for="chat_id" class="lbl">Admin chat_id</label>
    <input type="number" id="chat_id" placeholder="e.g. 123456789" required />
    <div id="statusRow" class="muted">
      Checking KV and Bot status...
    </div>
    <div class="row">
      <button id="sendCodeBtn">Send Code</button>
      <input type="number" id="otp" placeholder="Enter OTP" style="display:none" />
      <button id="verifyBtn" style="display:none">Verify</button>
    </div>
  </div>
  <!-- Admin top tabs -->
  <div id="adminTabs" style="display:none; margin: .5rem 0 1rem;">
    <div class="tabs" role="tablist" aria-label="Admin Sections">
      <button type="button" class="tab active" id="tab-manage" role="tab" aria-selected="true">Manage Data</button>
      <button type="button" class="tab" id="tab-stats" role="tab" aria-selected="false">User Stats</button>
    </div>
  </div>

  <form id="countryForm" style="display:none">
    <div class="tabs" role="tablist" aria-label="Admin Dataset Mode" style="margin-bottom:.75rem;">
      <button type="button" class="tab active" id="mode-dns" role="tab" aria-selected="true">DNS</button>
      <button type="button" class="tab" id="mode-wg" role="tab" aria-selected="false">Wireguard Endpoints</button>
      <button type="button" class="tab" id="mode-apn" role="tab" aria-selected="false">APN</button>
    </div>
    <div class="form-grid">
      <div class="form-col">
        <label class="lbl" for="countrySelect">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø´ÙˆØ± (Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯Ù†)</label>
        <select id="countrySelect"></select>

        <label class="lbl" for="name" id="lblName">Ù†Ø§Ù… Ú©Ø´ÙˆØ± Ø¬Ø¯ÛŒØ¯ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯)</label>
        <input type="text" id="name" placeholder="Ù…Ø«Ø§Ù„: Ukraine" />

        <label class="lbl" for="code" id="lblCode">Ú©Ø¯ Ú©Ø´ÙˆØ± (ISO-3166 alpha-2 Ù…Ø«Ù„ ua, gb, de)</label>
        <input type="text" id="code" placeholder="ua, gb, de, fr ..." />

        <label class="lbl" for="faName" id="lblFa">Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ú©Ø´ÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <input type="text" id="faName" placeholder="Ù…Ø«Ø§Ù„: Ø§ÙˆÚ©Ø±Ø§ÛŒÙ†" />
      </div>
    </div>

    <div id="countryPreview" class="muted" style="display:none;margin:.5rem 0 1rem;">
      <div id="prevRow" style="display:flex;align-items:center;gap:.5rem;">
        <img id="prevFlag" alt="flag" style="width:28px;height:20px;border-radius:3px;object-fit:cover;display:none" />
        <div id="prevMeta"></div>
        <div style="margin-inline-start:auto;display:flex;gap:.5rem;align-items:center;">
          <button type="button" id="refreshStats">Refresh Stats</button>
          <button type="button" id="previewAddrs">Preview Addresses</button>
          <button type="button" id="clearBusy" class="danger-btn">Clear Busy</button>
        </div>
      </div>
      <div id="prevStats" class="muted" style="margin-top:.25rem"></div>
      <div id="prevList" class="muted" style="margin-top:.25rem;max-height:160px;overflow:auto;display:none;"></div>
    </div>

    <label class="lbl" for="addresses" id="addrLabel">Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ IPv4 (Ù‡Ø± Ø®Ø· ÛŒÚ© Ø¢Ø¯Ø±Ø³)</label>
    <textarea id="addresses" placeholder="45.153.38.148\n46.33.136.18\n86.104.12.89\n45.14.247.217" required></textarea>
    <div id="ipHelper" class="muted" style="margin-top:.25rem"></div>

    <div class="row end">
      <button type="button" id="deleteBtn" class="danger-btn" style="margin-inline-end:auto">Delete</button>
      <button type="submit">Add / Update</button>
    </div>

    <hr style="margin:1.25rem 0; border:none; border-top:1px solid rgba(255,255,255,0.15)">

    <h3 style="margin:.25rem 0 .5rem;">Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ (USD)</h3>
    <div class="form-grid">
      <div class="form-col">
        <label class="lbl" for="bal_chat">chat_id Ú©Ø§Ø±Ø¨Ø± (Ø¹Ø¯Ø¯ÛŒ)</label>
        <input type="number" id="bal_chat" placeholder="Ù…Ø«Ø§Ù„: 123456789" />
      </div>
      <div class="form-col">
        <label class="lbl" for="bal_delta">ØªØºÛŒÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ÛŒ (Ø¨Ù‡ Ø¯Ù„Ø§Ø±Ø› Ù…Ù†ÙÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø³Ø±)</label>
        <input type="number" id="bal_delta" placeholder="Ù…Ø«Ø§Ù„: 10.00 ÛŒØ§ -5.25" step="0.01" />
      </div>
    </div>
    <div class="row end" style="margin-top:.5rem">
      <button type="button" id="bal_apply">Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
    </div>
  </form>
  <!-- Gift Code Management -->
  <section id="giftSection" style="display:none; margin-top:1rem;">
    <h3 style="margin:.25rem 0 .5rem;">Ø§ÛŒØ¬Ø§Ø¯ Ú¯ÛŒÙØª Ú©Ø¯</h3>
    <div class="form-grid">
      <div class="form-col">
        <label class="lbl" for="gift_code">Ú©Ø¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒØ› Ø®Ø§Ù„ÛŒ Ø¨Ù…Ø§Ù†Ø¯ ØªØ§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯)</label>
        <input type="text" id="gift_code" placeholder="Ù…Ø«Ø§Ù„: WELCOME2025" />
      </div>
      <div class="form-col">
        <label class="lbl" for="gift_amount">Ù…Ø¨Ù„Øº (Ø¯Ù„Ø§Ø±)</label>
        <input type="number" id="gift_amount" placeholder="Ù…Ø«Ø§Ù„: 5.00" step="0.01" />
      </div>
    </div>
    <div class="form-grid" style="margin-top:.5rem; align-items:end;">
      <div class="form-col">
        <label class="lbl" for="gift_max">Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ (0 = Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯)</label>
        <input type="number" id="gift_max" placeholder="0" />
      </div>
      <div class="form-col">
        <label class="lbl" for="gift_once">Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±</label>
        <div style="display:flex;align-items:center;gap:.5rem;">
          <input type="checkbox" id="gift_once" checked />
          <label for="gift_once" class="muted">Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± ÛŒÚ© Ø¨Ø§Ø±</label>
        </div>
      </div>
    </div>
    <div class="row end" style="margin-top:.5rem">
      <button type="button" id="gift_create_btn">Ø§ÛŒØ¬Ø§Ø¯ Ú¯ÛŒÙØª Ú©Ø¯</button>
    </div>
    <div id="gift_result" class="muted" style="margin-top:.5rem"></div>
  </section>
  
  <!-- Gift Code Redeem Section -->
  <section id="redeemSection" style="display:none; margin-top:1rem;">
    <h3 style="margin:.25rem 0 .5rem;">ØªØ³Øª Ø±ÛŒØ¯ÛŒÙ… Ú©Ø¯</h3>
    <div class="form-grid">
      <div class="form-col">
        <label class="lbl" for="redeem_chat">chat_id Ú©Ø§Ø±Ø¨Ø± (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)</label>
        <input type="number" id="redeem_chat" placeholder="Ù…Ø«Ø§Ù„: 123456789" />
      </div>
      <div class="form-col">
        <label class="lbl" for="redeem_code">Ú©Ø¯ Ú¯ÛŒÙØª</label>
        <input type="text" id="redeem_code" placeholder="Ù…Ø«Ø§Ù„: WELCOME2025" />
      </div>
    </div>
    <div class="row end" style="margin-top:.5rem">
      <button type="button" id="redeem_test_btn">ØªØ³Øª Ø±ÛŒØ¯ÛŒÙ… Ú©Ø¯</button>
    </div>
    <div id="redeem_result" class="muted" style="margin-top:.5rem"></div>
  </section>
  
  <!-- Gift Code List Management -->
  <section id="giftListSection" style="display:none; margin-top:1rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
      <h3 style="margin:0;">Ù…Ø¯ÛŒØ±ÛŒØª Ú¯ÛŒÙØª Ú©Ø¯Ù‡Ø§</h3>
      <button type="button" id="refresh_gift_list" class="primary-btn">
        <span style="margin-left:0.5rem;">ğŸ”„</span>
        Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª
      </button>
    </div>
    
    <div class="glass-card" style="overflow:auto; max-height:500px;">
      <table id="giftCodesTable" style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <thead>
          <tr style="background:rgba(255,255,255,0.1);">
            <th style="text-align:left; padding:0.75rem 0.5rem; border-bottom:2px solid rgba(255,255,255,0.2); font-weight:600;">ÙˆØ¶Ø¹ÛŒØª</th>
            <th style="text-align:left; padding:0.75rem 0.5rem; border-bottom:2px solid rgba(255,255,255,0.2); font-weight:600;">Ú©Ø¯</th>
            <th style="text-align:right; padding:0.75rem 0.5rem; border-bottom:2px solid rgba(255,255,255,0.2); font-weight:600;">Ù…Ø¨Ù„Øº</th>
            <th style="text-align:center; padding:0.75rem 0.5rem; border-bottom:2px solid rgba(255,255,255,0.2); font-weight:600;">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡</th>
            <th style="text-align:center; padding:0.75rem 0.5rem; border-bottom:2px solid rgba(255,255,255,0.2); font-weight:600;">Ø­Ø¯Ø§Ú©Ø«Ø±</th>
            <th style="text-align:center; padding:0.75rem 0.5rem; border-bottom:2px solid rgba(255,255,255,0.2); font-weight:600;">Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ú©Ø§Ø±Ø¨Ø±</th>
            <th style="text-align:center; padding:0.75rem 0.5rem; border-bottom:2px solid rgba(255,255,255,0.2); font-weight:600;">Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
        </thead>
        <tbody id="giftCodesTbody">
          <tr><td style="padding:1rem; text-align:center;" colspan="7" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
        </tbody>
      </table>
    </div>
    
    <div id="gift_list_stats" class="muted" style="margin-top:0.5rem; padding:0.5rem; background:rgba(255,255,255,0.05); border-radius:8px;">
      Ø¢Ù…Ø§Ø±: - Ú©Ø¯ ÙØ¹Ø§Ù„ | - Ú©Ø¯ ØºÛŒØ±ÙØ¹Ø§Ù„ | - Ú©Ù„ Ù…Ø¨Ù„Øº
    </div>
  </section>
  <!-- Admin Stats Section -->
  <section id="adminStatsSection" style="display:none">
    <div class="form-grid" style="align-items:flex-end">
      <div class="form-col">
        <h3 style="margin:.25rem 0 .5rem;">Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
        <div class="muted" id="statsSummary">Loading...</div>
      </div>
      <div class="form-col" style="text-align:end">
        <button type="button" id="statsRefresh">Refresh</button>
      </div>
    </div>
    <div class="glass-card" style="margin-top:.5rem; overflow:auto">
      <table id="usersTable" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid rgba(255,255,255,.15)">Chat ID</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid rgba(255,255,255,.15)">Verified</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid rgba(255,255,255,.15)">Balance (USD)</th>
          </tr>
        </thead>
        <tbody id="usersTbody">
          <tr><td style="padding:.5rem;" colspan="3" class="muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </section>
  </div>
  <script>
    // Helper function to normalize country names
    function normalizeCountryName(country) {
      const normalized = String(country || '').toLowerCase().trim();
      // Normalize England, UK, United Kingdom, Great Britain, GB to England
      if (normalized === 'england' || normalized === 'uk' || normalized === 'united kingdom' || 
          normalized === 'great britain' || normalized === 'gb' || normalized === 'Ø§Ù†Ú¯Ù„ÛŒØ³') {
        return 'England';
      }
      // Normalize America, USA, United States to a single name
      if (normalized === 'america' || normalized === 'usa' || normalized === 'united states' || normalized === 'united states of america') {
        return 'United States';
      }
      // Return original country name with proper capitalization
      return String(country || '').trim();
    }

    // --- Error modal helper ---
    (function(){
      const overlay = document.getElementById('alertOverlay');
      const container = document.getElementById('alertContainer');
      const titleEl = document.getElementById('alertTitle');
      const msgEl = document.getElementById('alertMsg');
      const okBtn = document.getElementById('alertOk');
      const xBtn = document.getElementById('alertX');
      function close(){ overlay.classList.remove('active'); container.classList.remove('active'); }
      function open(title, message, asHtml){
        titleEl.textContent = title || 'Ù¾ÛŒØ§Ù…';
        if(asHtml){ msgEl.innerHTML = message || ''; }
        else { msgEl.textContent = message || ''; }
        overlay.classList.add('active');
        container.classList.add('active');
      }

    // Gift Create wiring
    (function(){
      const btn = document.getElementById('gift_create_btn');
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        const code = (document.getElementById('gift_code').value||'').trim();
        const amount = parseFloat(document.getElementById('gift_amount').value||'0');
        const max_uses = parseInt(document.getElementById('gift_max').value||'0',10) || 0;
        const per_user_once = !!document.getElementById('gift_once').checked;
        if(!Number.isFinite(amount) || amount<=0){ window.showError('Ù…Ø¨Ù„Øº Ù†Ø§Ù…Ø¹ØªØ¨Ø±'); return; }
        const body = { session: localStorage.getItem('adminSession'), code, amount, per_user_once, max_uses };
        try{
          const r = await fetch('/admin/gift-create',{ method:'POST', headers: adminHeaders(), body: JSON.stringify(body) });
          if(!r.ok){
            let msg = 'Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯';
            try{ const j = await r.json(); if(j && (j.message||j.error)) msg = j.message || j.error; }catch(_){ }
            window.showError(msg);
            return;
          }
          const j = await r.json();
          const res = document.getElementById('gift_result');
          if(res){ res.textContent = `Ú©Ø¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯: ${j.gift && j.gift.code ? j.gift.code : ''} | Ù…Ø¨Ù„Øº: $${(j.gift && j.gift.amount!=null? j.gift.amount.toFixed(2):'0.00')} | Ù…Ø­Ø¯ÙˆØ¯ÛŒØª: ${j.gift && j.gift.max_uses? j.gift.max_uses : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}`; }
          window.showMessage('Ú¯ÛŒÙØª Ú©Ø¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯','Ù¾ÛŒØ§Ù…');
        }catch(e){ window.showError('Network error'); }
      });
    })();
    
    // Gift Redeem wiring
    (function(){
      const btn = document.getElementById('redeem_test_btn');
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        const chat_id = (document.getElementById('redeem_chat').value||'').trim();
        const code = (document.getElementById('redeem_code').value||'').trim();
        if(!chat_id){ window.showError('chat_id Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
        if(!code){ window.showError('Ú©Ø¯ Ú¯ÛŒÙØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
        
        // Create a temporary session for the user to test redeem
        const adminSession = localStorage.getItem('adminSession');
        if(!adminSession){ window.showError('Admin session missing'); return; }
        
        try{
          // First create a temporary session for the test user
          const sessionRes = await fetch('/admin/create-temp-session', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ session: adminSession, chat_id })
          });
          
          let tempSession;
          if(sessionRes.ok){
            const sessionData = await sessionRes.json();
            tempSession = sessionData.temp_session;
          } else {
            // Fallback: use admin session but with different approach
            tempSession = adminSession;
          }
          
          // Now try to redeem the gift code
          const r = await fetch('/gift/redeem', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${tempSession}`
            },
            body: JSON.stringify({ code })
          });
          
          const res = document.getElementById('redeem_result');
          if(r.ok){
            const j = await r.json();
            if(res){ res.textContent = `Ø±ÛŒØ¯ÛŒÙ… Ù…ÙˆÙÙ‚: Ù…Ø¨Ù„Øº $${(j.amount||0).toFixed(2)} Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± ${chat_id} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: $${(j.balance||0).toFixed(2)}`; }
            window.showMessage('Ú©Ø¯ Ú¯ÛŒÙØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±ÛŒØ¯ÛŒÙ… Ø´Ø¯','Ù¾ÛŒØ§Ù…');
          } else {
            let msg = 'Ø±ÛŒØ¯ÛŒÙ… Ù†Ø§Ù…ÙˆÙÙ‚';
            try{ 
              const j = await r.json(); 
              if(j && (j.message||j.error)) msg = j.message || j.error;
              if(j.error === 'already_used') msg = 'Ø§ÛŒÙ† Ú©Ø¯ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª';
              if(j.error === 'not_found') msg = 'Ú©Ø¯ Ú¯ÛŒÙØª ÛŒØ§ÙØª Ù†Ø´Ø¯';
              if(j.error === 'exhausted') msg = 'Ø­Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ú©Ø¯ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª';
            }catch(_){ }
            if(res){ res.textContent = `Ø®Ø·Ø§: ${msg}`; }
            window.showError(msg);
          }
        }catch(e){ 
          window.showError('Network error');
          const res = document.getElementById('redeem_result');
          if(res){ res.textContent = 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡'; }
        }
      });
    })();
    
    // Gift Code List Management
    (function(){
      const listSection = document.getElementById('giftListSection');
      const refreshBtn = document.getElementById('refresh_gift_list');
      const tbody = document.getElementById('giftCodesTbody');
      const statsDiv = document.getElementById('gift_list_stats');
      
      async function loadGiftCodes(){
        const session = localStorage.getItem('adminSession');
        if(!session){ window.showError('Admin session missing'); return; }
        
        try{
          if(tbody) tbody.innerHTML = '<tr><td style="padding:1rem; text-align:center;" colspan="7" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>';
          
          const r = await fetch('/admin/gift-list', { 
            headers: { 
              'Authorization': `Bearer ${session}`,
              'Content-Type': 'application/json'
            } 
          });
          
          if(!r.ok){
            if(r.status === 401){ 
              invalidateAdminSession(); 
              window.showError(UNAUTH_MSG); 
              return; 
            }
            window.showError('Failed to load gift codes');
            return;
          }
          
          const data = await r.json();
          const codes = Array.isArray(data.codes) ? data.codes : [];
          
          if(codes.length === 0){
            tbody.innerHTML = '<tr><td style="padding:1rem; text-align:center;" colspan="7" class="muted">Ù‡ÛŒÚ† Ú¯ÛŒÙØª Ú©Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
            if(statsDiv) statsDiv.textContent = 'Ø¢Ù…Ø§Ø±: 0 Ú©Ø¯ ÙØ¹Ø§Ù„ | 0 Ú©Ø¯ ØºÛŒØ±ÙØ¹Ø§Ù„ | $0.00 Ú©Ù„ Ù…Ø¨Ù„Øº';
            return;
          }
          
          // Calculate stats
          let activeCount = 0;
          let inactiveCount = 0;
          let totalAmount = 0;
          
          // Sort codes by creation date (newest first) and then by status
          codes.sort((a, b) => {
            const aActive = isGiftCodeActive(a);
            const bActive = isGiftCodeActive(b);
            if(aActive !== bActive) return bActive - aActive; // Active first
            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
          });
          
          const rows = codes.map(code => {
            const isActive = isGiftCodeActive(code);
            if(isActive) activeCount++;
            else inactiveCount++;
            totalAmount += Number(code.amount || 0);
            
            const statusIcon = isActive 
              ? '<span style="color:#22c55e; font-size:1.2em;" title="ÙØ¹Ø§Ù„">â—</span>'
              : '<span style="color:#ef4444; font-size:1.2em;" title="ØºÛŒØ±ÙØ¹Ø§Ù„">â—</span>';
            
            const usedCount = Number(code.used_count || 0);
            const maxUses = Number(code.max_uses || 0);
            const maxUsesText = maxUses === 0 ? 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯' : maxUses.toString();
            const perUserOnce = code.per_user_once ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±';
            
            const usageText = maxUses === 0 ? usedCount.toString() : `${usedCount}/${maxUses}`;
            const usageColor = (maxUses > 0 && usedCount >= maxUses) ? 'color:#ef4444;' : '';
            
            return `
              <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                <td style="padding:0.5rem; text-align:center;">${statusIcon}</td>
                <td style="padding:0.5rem; font-family:monospace; font-weight:600; color:#7fd1ff;">${code.code || ''}</td>
                <td style="padding:0.5rem; text-align:right; font-weight:600;">$${Number(code.amount || 0).toFixed(2)}</td>
                <td style="padding:0.5rem; text-align:center; ${usageColor}">${usageText}</td>
                <td style="padding:0.5rem; text-align:center;">${maxUsesText}</td>
                <td style="padding:0.5rem; text-align:center;">${perUserOnce}</td>
                <td style="padding:0.5rem; text-align:center;">
                  <button onclick="copyGiftCode('${code.code}')" style="padding:0.25rem 0.5rem; font-size:0.8rem; border-radius:4px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; cursor:pointer;" title="Ú©Ù¾ÛŒ Ú©Ø¯">ğŸ“‹</button>
                  ${isActive ? `<button onclick="deactivateGiftCode('${code.code}')" style="padding:0.25rem 0.5rem; font-size:0.8rem; border-radius:4px; background:#ef4444; border:1px solid #dc2626; color:white; cursor:pointer; margin-left:0.25rem;" title="ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù†">ğŸš«</button>` : ''}
                </td>
              </tr>
            `;
          }).join('');
          
          tbody.innerHTML = rows;
          
          // Update stats
          if(statsDiv){
            statsDiv.innerHTML = `
              Ø¢Ù…Ø§Ø±: 
              <span style="color:#22c55e; font-weight:600;">${activeCount} Ú©Ø¯ ÙØ¹Ø§Ù„</span> | 
              <span style="color:#ef4444; font-weight:600;">${inactiveCount} Ú©Ø¯ ØºÛŒØ±ÙØ¹Ø§Ù„</span> | 
              <span style="color:#7fd1ff; font-weight:600;">$${totalAmount.toFixed(2)} Ú©Ù„ Ù…Ø¨Ù„Øº</span>
            `;
          }
          
        }catch(e){
          console.error('Gift codes load error:', e);
          if(tbody) tbody.innerHTML = '<tr><td style="padding:1rem; text-align:center;" colspan="7" class="muted">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</td></tr>';
          window.showError('Network error');
        }
      }
      
      function isGiftCodeActive(code){
        const maxUses = Number(code.max_uses || 0);
        const usedCount = Number(code.used_count || 0);
        
        // If max_uses is 0, it's unlimited
        if(maxUses === 0) return true;
        
        // If used count has reached max uses, it's inactive
        return usedCount < maxUses;
      }
      
      // Global functions for button actions
      window.copyGiftCode = async function(code){
        try{
          await navigator.clipboard.writeText(code);
          window.showMessage(`Ú©Ø¯ ${code} Ú©Ù¾ÛŒ Ø´Ø¯`);
        }catch(e){
          window.showError('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†');
        }
      };
      
      window.deactivateGiftCode = async function(code){
        if(!confirm(`Ø¢ÛŒØ§ Ø§Ø² ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©Ø¯ ${code} Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ`)) return;
        
        const session = localStorage.getItem('adminSession');
        if(!session){ window.showError('Admin session missing'); return; }
        
        try{
          const r = await fetch('/admin/gift-deactivate', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ session, code })
          });
          
          if(r.ok){
            window.showMessage(`Ú©Ø¯ ${code} ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯`);
            loadGiftCodes(); // Refresh list
          } else {
            if(r.status === 401){ 
              invalidateAdminSession(); 
              window.showError(UNAUTH_MSG); 
            } else {
              window.showError('Ø®Ø·Ø§ Ø¯Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©Ø¯');
            }
          }
        }catch(e){
          window.showError('Network error');
        }
      };
      
      if(refreshBtn){
        refreshBtn.addEventListener('click', loadGiftCodes);
      }
      
      // Auto-load when admin session is available
      const observer = new MutationObserver(()=>{
        const visible = listSection && listSection.style.display !== 'none';
        if(visible && localStorage.getItem('adminSession')){
          loadGiftCodes();
          observer.disconnect();
        }
      });
      if(listSection) observer.observe(listSection, { attributes: true, attributeFilter: ['style'] });
      
    })();
      function showError(message, title){
        open(title || 'Ø®Ø·Ø§', message, false);
      }
      function showMessage(message, title){
        // Support line breaks in messages
        const html = String(message||'').replace(/\n/g, '<br>');
        open(title || 'Ù¾ÛŒØ§Ù…', html, true);
      }
      okBtn.addEventListener('click', close);
      xBtn.addEventListener('click', close);
      overlay.addEventListener('click', close);
      window.showError = showError;
      window.showMessage = showMessage;
    })();
    // --- Admin login logic ---
    const chatInput=document.getElementById('chat_id');
    const otpInput=document.getElementById('otp');
    const sendBtn=document.getElementById('sendCodeBtn');
    const verifyBtn=document.getElementById('verifyBtn');
    const loginSection=document.getElementById('loginSection');
    const countryForm=document.getElementById('countryForm');
    const statusRow=document.getElementById('statusRow');
    const selEl = document.getElementById('countrySelect');
  const nameEl = document.getElementById('name');
  const codeEl = document.getElementById('code');
  const faEl = document.getElementById('faName');
  const lblName = document.getElementById('lblName');
  const lblCode = document.getElementById('lblCode');
  const lblFa = document.getElementById('lblFa');
  const addrEl = document.getElementById('addresses');
  const addrLabel = document.getElementById('addrLabel');
  const modeDnsBtn = document.getElementById('mode-dns');
  const modeWgBtn = document.getElementById('mode-wg');
  const modeApnBtn = document.getElementById('mode-apn');
  let adminMode = 'dns'; // 'dns' | 'wg' | 'apn'
  let countriesCache = [];
  // Preview elements
  const prevWrap = document.getElementById('countryPreview');
  const prevFlag = document.getElementById('prevFlag');
  const prevMeta = document.getElementById('prevMeta');
  const prevStats = document.getElementById('prevStats');
  const prevList = document.getElementById('prevList');
  const refreshStatsBtn = document.getElementById('refreshStats');
  const previewAddrsBtn = document.getElementById('previewAddrs');
  const clearBusyBtn = document.getElementById('clearBusy');
  const ipHelper = document.getElementById('ipHelper');
  // Admin section tabs
  const adminTabs = document.getElementById('adminTabs');
  const tabManage = document.getElementById('tab-manage');
  const tabStats = document.getElementById('tab-stats');
  const statsSection = document.getElementById('adminStatsSection');
  const statsSummary = document.getElementById('statsSummary');
  const statsRefresh = document.getElementById('statsRefresh');
  const usersTbody = document.getElementById('usersTbody');
  const logoutBtn = document.getElementById('logoutBtn');

  // Helper to include admin session as Authorization header for all admin APIs
  function adminHeaders(json = true){
    const s = localStorage.getItem('adminSession') || '';
    const h = {};
    if(json) h['Content-Type'] = 'application/json';
    if(s) h['Authorization'] = `Bearer ${s}`;
    return h;
  }

  // Central unauthorized handler to reset UI and prompt re-login
  const UNAUTH_MSG = 'Unauthorized: Ù„Ø·ÙØ§Ù‹ Ø¯Ø± Ø¨Ø®Ø´ Ø¨Ø§Ù„Ø§ Ø¨Ø§ OTP ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ (Admin session).';
  function invalidateAdminSession(){
    try { localStorage.removeItem('adminSession'); } catch(_){ }
    if(loginSection) loginSection.style.display='block';
    if(countryForm) countryForm.style.display='none';
    if(statsSection) statsSection.style.display='none';
    if(adminTabs) adminTabs.style.display='none';
    if(logoutBtn) logoutBtn.style.display='none';
  }

  // Load users list for stats
  async function loadAdminUsers(){
    try{
      if(usersTbody) usersTbody.innerHTML = '<tr><td style="padding:.5rem;" colspan="3" class="muted">Loading...</td></tr>';
      const r = await fetch('/admin/users', { headers: adminHeaders(false) });
      if(!r.ok){
        if(r.status===401){ invalidateAdminSession(); window.showError(UNAUTH_MSG); return; }
        window.showError('Failed to load users'); return;
      }
      const j = await r.json();
      const users = Array.isArray(j.users) ? j.users : [];
      if(statsSummary) statsSummary.textContent = `Total users: ${j.total||users.length} | Total balance: $${(j.total_balance!=null? Number(j.total_balance).toFixed(2) : '0.00')}`;
      if(!users.length){
        usersTbody.innerHTML = '<tr><td style="padding:.5rem;" colspan="3" class="muted">No users found.</td></tr>';
        return;
      }
      const rows = users.map(u=>{
        const bal = Number.isFinite(u.balance) ? u.balance.toFixed(2) : '0.00';
        const ver = u.verified ? 'Yes' : 'No';
        return `<tr>
          <td style="padding:.5rem; border-bottom:1px solid rgba(255,255,255,.06);">${u.chat_id||''}</td>
          <td style="padding:.5rem; border-bottom:1px solid rgba(255,255,255,.06);">${ver}</td>
          <td style="padding:.5rem; border-bottom:1px solid rgba(255,255,255,.06); direction:ltr;">$${bal}</td>
        </tr>`;
      }).join('');
      usersTbody.innerHTML = rows;
    }catch(_){ if(usersTbody) usersTbody.innerHTML = '<tr><td style="padding:.5rem;" colspan="3" class="muted">Load failed.</td></tr>'; }
  }

    // Show KV/Bot status
    (async ()=>{
      try{
        const r = await fetch('/status');
        if(r.ok){
          const {kv, db, bot} = await r.json();
          statusRow.textContent = `DB: ${db? 'Connected' : 'Not available'} | KV: ${kv? 'Connected' : 'Not available'} | Bot token: ${bot? 'Configured' : 'Missing'}`;
          statusRow.style.color = kv && bot ? '#9cff9c' : '#ffd27a';
        } else {
          statusRow.textContent = 'Unable to read status endpoint';
          statusRow.style.color = '#ffd27a';
        }
      }catch(e){
        statusRow.textContent = 'Status check failed';
        statusRow.style.color = '#ffd27a';
      }
    })();

    // --- Logout wiring ---
    if(logoutBtn){
      logoutBtn.addEventListener('click', ()=>{
        invalidateAdminSession();
        window.showMessage('Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.','Ù¾ÛŒØ§Ù…');
      });
    }

    // Prefill chat_id from localStorage
    chatInput.value = localStorage.getItem('adminChatId') || '';

    sendBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const chat_id=chatInput.value.trim();
      if(!chat_id) return window.showError('Enter chat_id');
      localStorage.setItem('adminChatId', chat_id);
      const res=await fetch('/auth/send-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id})});
      if(res.ok){
        const {next_retry_sec=30} = await res.json().catch(()=>({}));
        window.showMessage('Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù†Ú¯Ø±ÙØªÛŒØ¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ø±Ø¨Ø§Øª Ø²ÛŒØ± Start Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Ù…Ø¬Ø¯Ø¯ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯:\n@minidnsverify_bot','Ù¾ÛŒØ§Ù…');
        otpInput.style.display='block';
        verifyBtn.style.display='inline-block';
        // prevent spamming button for 30s
        sendBtn.disabled = true;
        let left = next_retry_sec || 30;
        const original = 'Send Code';
        const t = setInterval(()=>{
          left -= 1;
          if(left<=0){
            clearInterval(t);
            sendBtn.disabled=false;
            sendBtn.textContent=original;
          } else {
            sendBtn.textContent = `${original} (${left})`;
          }
        },1000);
      }else window.showError('Error sending code');
    });

    // --- Delete country logic ---
    document.getElementById('deleteBtn').addEventListener('click', async ()=>{
      const rawCountry = (document.getElementById('countrySelect').value || document.getElementById('name').value || '').trim();
      const country = normalizeCountryName(rawCountry);
      if(!country){ window.showError('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø´ÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ù†Ø§Ù… Ø¢Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      if(!confirm(`Ø­Ø°Ù Ú©Ø´ÙˆØ± Â«${country}Â» Ùˆ ØªÙ…Ø§Ù… IP Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·ØŸ`)) return;
      const body = { session: localStorage.getItem('adminSession'), country };
      try{
        const r = await fetch('/admin/delete', { method:'POST', headers: adminHeaders(), body: JSON.stringify(body) });
        if(r.ok){
          window.showMessage('Deleted','Ù¾ÛŒØ§Ù…');
          // reset form
          document.getElementById('name').value='';
          document.getElementById('code').value='';
          document.getElementById('faName').value='';
          document.getElementById('addresses').value='';
          await populateCountries();
        } else {
          if(r.status===401){ invalidateAdminSession(); window.showError(UNAUTH_MSG); }
          else { window.showError('Delete failed'); }
        }
      }catch(e){ window.showError('Network error'); }
    });

    verifyBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const chat_id=chatInput.value.trim();
      const code=otpInput.value.trim();
      if(!code) return window.showError('Enter code');
      const res=await fetch('/auth/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id,code})});
      if(res.ok){
        const {session}=await res.json();
        localStorage.setItem('adminSession',session);
        loginSection.style.display='none';
        countryForm.style.display='block';
        // show gift section once admin logged in
        const giftSec = document.getElementById('giftSection');
        if(giftSec) giftSec.style.display='block';
        // show redeem section once admin logged in
        const redeemSec = document.getElementById('redeemSection');
        if(redeemSec) redeemSec.style.display='block';
        // show gift list section once admin logged in
        const giftListSec = document.getElementById('giftListSection');
        if(giftListSec) giftListSec.style.display='block';
        // populate countries select
        await populateCountries();
        // notify owner about admin login
        try{ await fetch('/admin/notify-login',{method:'POST',headers: adminHeaders(),body:JSON.stringify({session})}); }catch(_e){}
      }else window.showError('Verification failed');
    });

    // --- Add country form logic ---
    document.getElementById('countryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const rawCountry = selEl.value.trim() || nameEl.value.trim();
      const country = normalizeCountryName(rawCountry);
      const session = localStorage.getItem('adminSession');
      if(!session){ window.showError('Unauthorized: Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ø¨Ø§Ù„Ø§ Ø¨Ø§ OTP ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ØªØ§ Ø³Ø´Ù† Ø§Ø¯Ù…ÛŒÙ† ÙØ¹Ø§Ù„ Ø´ÙˆØ¯.'); return; }
      // If creating a NEW country (no selection), require a valid 2-letter ISO code
      if(!selEl.value.trim()){
        const iso = (codeEl.value||'').trim().toLowerCase();
        if(!/^[a-z]{2}$/.test(iso)){
          window.showError('Ú©Ø¯ Ú©Ø´ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø´ÙˆØ± Ø¬Ø¯ÛŒØ¯ØŒ Ú©Ø¯ Ø¯ÙˆØ­Ø±ÙÛŒ ISO-3166 Ù…Ø«Ù„ ua, gb, de ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
          return;
        }
        codeEl.value = iso; // normalize
      }
      const base = { session, country, code: (codeEl.value||'').trim().toLowerCase(), faName: faEl.value.trim() };
      const lines = addrEl.value.split('\n').map(s=>s.trim()).filter(Boolean);
      let body;
      if(adminMode==='dns') body = { ...base, addresses: lines };
      else if(adminMode==='wg') body = { ...base, endpoints: lines };
      else body = { ...base, apn: lines };
      try {
        let url = '/admin/add-address';
        if(adminMode==='wg') url = '/admin/wg-add';
        if(adminMode==='apn') url = '/admin/apn-add';
        const res = await fetch(url, { method: 'POST', headers: adminHeaders(), body: JSON.stringify(body) });
        if(res.ok){
          window.showMessage('Added!','Ù¾ÛŒØ§Ù…');
          e.target.reset();
          await populateCountries();
          updateFormMode();
        } else {
          let msg = 'Error adding entries';
          try{
            const ct = res.headers.get('Content-Type')||'';
            if(ct.includes('application/json')){
              const j = await res.json();
              if(typeof j === 'string' && j) msg = j;
              else if(j && (j.error||j.message)) msg = j.error || j.message;
            } else {
              const t = await res.text();
              if(t) msg = t;
            }
          }catch(_e){}
          if(res.status===401){ msg = UNAUTH_MSG; invalidateAdminSession(); }
          if(res.status===403) msg = 'Forbidden: Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª.';
          if(res.status===400 && /Invalid country code/i.test(msg)){
            msg = 'Ú©Ø¯ Ú©Ø´ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø´ÙˆØ± Ø¬Ø¯ÛŒØ¯ØŒ Ú©Ø¯ Ø¯ÙˆØ­Ø±ÙÛŒ ISO-3166 Ù…Ø«Ù„ ua, gb, de ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
          }
          window.showError(msg);
        }
      } catch(err){
        console.error(err);
        window.showError('Network error');
      }
    });

    async function populateCountries(preserveSelection = true){
      try {
        let countries = [];
        if(adminMode === 'dns'){
          // DNS countries dataset (all)
          try{
            const resCountries = await fetch('/countries');
            if(resCountries.ok){
              countries = await resCountries.json();
            } else {
              throw new Error('fallback');
            }
          } catch(_){
            try{
              const resLocal = await fetch('countries.json');
              if(resLocal.ok) countries = await resLocal.json();
            }catch(__){}
          }
        } else if (adminMode === 'apn') {
          // APN: load only from local APN file
          try{
            const resLocalApn = await fetch('country-apn.json');
            if(resLocalApn.ok){
              const j2 = await resLocalApn.json();
              if(Array.isArray(j2)) countries = j2;
            }
          }catch(__){}
          // 3) Final fallback: allow selecting from all countries to add new APN entries
          if(!Array.isArray(countries) || countries.length===0){
            try{
              const resCountries = await fetch('/countries');
              if(resCountries.ok){
                countries = await resCountries.json();
              } else {
                throw new Error('fallback');
              }
            } catch(_){
              try{
                const resLocal = await fetch('countries.json');
                if(resLocal.ok) countries = await resLocal.json();
              }catch(__){}
            }
          }
        } else {
          // WireGuard countries dataset (only those that have endpoints)
          try{
            const resWg = await fetch('/wireguard-countries');
            if(resWg.ok){
              const j = await resWg.json();
              if(Array.isArray(j) && j.length>0) countries = j; else throw new Error('fallback');
            } else {
              throw new Error('fallback');
            }
          } catch(_){
            try{
              const resLocalWg = await fetch('wireguard-countries.json');
              if(resLocalWg.ok) countries = await resLocalWg.json();
            }catch(__){}
          }
        }
        // Optionally fetch per-country totals for current mode and sort by total desc
        let endpointBase = '/stats/';
        if(adminMode==='wg') endpointBase = '/wg-stats/';
        if(adminMode==='apn') endpointBase = '/apn-stats/';
        const totals = await Promise.allSettled((countries||[]).map(async (c)=>{
          const name = c && c.name ? String(c.name) : '';
          if(!name) return { name: '', total: 0 };
          try{
            const r = await fetch(endpointBase + encodeURIComponent(name));
            if(r && r.ok){
              const s = await r.json();
              return { name, total: Number(s && s.total || 0) };
            }
          }catch(__){}
          return { name, total: 0 };
        }));
        const totalMap = new Map();
        for(const t of totals){
          if(t.status==='fulfilled' && t.value && t.value.name){ totalMap.set(t.value.name, t.value.total||0); }
        }
        countries.sort((a,b)=>{
          const ta = totalMap.get(a.name) || 0;
          const tb = totalMap.get(b.name) || 0;
          if(tb!==ta) return tb - ta; // bigger first
          return String(a.name||'').localeCompare(String(b.name||''));
        });
        countriesCache = countries;
        const prevSel = preserveSelection ? (selEl.value || '') : '';
        selEl.innerHTML='';
        const placeholder = document.createElement('option');
        placeholder.value='';
        placeholder.textContent='â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø´ÙˆØ± â€”';
        selEl.appendChild(placeholder);
        countries.forEach(c=>{
          const opt = document.createElement('option');
          opt.value=c.name;
          const fa = (c.faName||'').trim();
          opt.textContent = fa ? `${c.name} (${fa})` : c.name;
          selEl.appendChild(opt);
        });
        // Try to restore previous selection if it still exists
        if(prevSel){
          selEl.value = prevSel;
        }
        updateFormMode();
      }catch(e){ console.error(e); window.showError('Failed to load countries'); }
    }

    function hideMetaFields(){
      lblName.style.display='none';
      nameEl.style.display='none';
      lblCode.style.display='none';
      codeEl.style.display='none';
      lblFa.style.display='none';
      faEl.style.display='none';
    }
    function showMetaFields(){
      lblName.style.display='block';
      nameEl.style.display='block';
      lblCode.style.display='block';
      codeEl.style.display='block';
      lblFa.style.display='block';
      faEl.style.display='block';
    }
    function updateFormMode(){
      const sel = selEl.value.trim();
      if(sel){
        // existing country selected => keep only addresses visible
        const found = countriesCache.find(c=>String(c.name).toLowerCase()===sel.toLowerCase());
        if(found){
          // prefill code/fa
          codeEl.value = (found.code||'').toLowerCase();
          faEl.value = found.faName || '';
        }
        hideMetaFields();
        renderCountryPreview();
      } else {
        // creating new => show all fields
        showMetaFields();
        codeEl.value = codeEl.value; // keep user input
        faEl.value = faEl.value;
        prevWrap.style.display='none';
        prevList.style.display='none';
      }
    }
    selEl.addEventListener('change', updateFormMode);

    function renderCountryPreview(){
      const sel = selEl.value.trim();
      if(!sel){ prevWrap.style.display='none'; return; }
      const found = countriesCache.find(c=>String(c.name).toLowerCase()===sel.toLowerCase());
      const code = String((found && found.code) || codeEl.value || '').toLowerCase();
      const fa = (found && found.faName) || faEl.value || '';
      prevMeta.textContent = `${sel}${fa? ' â€” '+fa : ''}${code? ' â€” '+code.toUpperCase(): ''}`;
      if(code){
        prevFlag.src = `https://flagcdn.com/w40/${code}.png`;
        prevFlag.srcset = `https://flagcdn.com/w80/${code}.png 2x`;
        prevFlag.style.display='inline-block';
      } else {
        prevFlag.style.display='none';
      }
      prevWrap.style.display='block';
      // load stats automatically for current mode
      loadStatsFor(sel).catch(()=>{});
    }

    async function loadStatsFor(countryName){
      try{
        if(!countryName){ prevStats.textContent=''; return; }
        const normalizedCountry = normalizeCountryName(countryName);
        let endpoint;
        if(adminMode==='dns') endpoint = `/stats/${encodeURIComponent(normalizedCountry)}`;
        else if(adminMode==='wg') endpoint = `/wg-stats/${encodeURIComponent(normalizedCountry)}`;
        else endpoint = `/apn-stats/${encodeURIComponent(normalizedCountry)}`;
        const r = await fetch(endpoint);
        if(r.ok){
          const s = await r.json();
          prevStats.textContent = `Total: ${s.total} | Free: ${s.free} | Busy: ${s.busy}`;
        } else {
          prevStats.textContent = '';
        }
      }catch(_){ prevStats.textContent=''; }
    }

    refreshStatsBtn.addEventListener('click', ()=> loadStatsFor(selEl.value.trim()));
    previewAddrsBtn.addEventListener('click', async ()=>{
      const rawCountry = selEl.value.trim() || nameEl.value.trim();
      const country = normalizeCountryName(rawCountry);
      if(!country){ window.showError('Ø§Ø¨ØªØ¯Ø§ Ú©Ø´ÙˆØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      // APN list preview may not be supported; show friendly message
      if(adminMode==='apn'){
        window.showMessage('Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ø¨Ø±Ø§ÛŒ APN Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
        return;
      }
      try{
        const body = { session: localStorage.getItem('adminSession'), country };
        const url = adminMode==='dns' ? '/admin/list-addresses' : '/admin/wg-list';
        const r = await fetch(url, { method:'POST', headers: adminHeaders(), body: JSON.stringify(body) });
        if(r.ok){
          const { addresses=[] } = await r.json();
          prevList.style.display='block';
          prevList.textContent = addresses.length ? addresses.join('\n') : 'No addresses yet.';
        } else {
          if(r.status===401){ invalidateAdminSession(); window.showError(UNAUTH_MSG); }
          else { window.showError('Failed to load addresses'); }
        }
      }catch(_){ window.showError('Network error'); }
    });
    clearBusyBtn.addEventListener('click', async ()=>{
      const rawCountry = selEl.value.trim();
      const country = normalizeCountryName(rawCountry);
      if(!country){ window.showError('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø´ÙˆØ± Ù…ÙˆØ¬ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
      if(!confirm('Ù„ÛŒØ³Øª Busy Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø´ÙˆØ± Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) return;
      try{
        const body = { session: localStorage.getItem('adminSession'), country };
        let url = '/admin/clear-busy';
        if(adminMode==='wg') url = '/admin/wg-clear-busy';
        if(adminMode==='apn') url = '/admin/apn-clear-busy';
        const r = await fetch(url, { method:'POST', headers: adminHeaders(), body: JSON.stringify(body) });
        if(r.ok){
          window.showMessage('Busy cleared','Ù¾ÛŒØ§Ù…');
          await loadStatsFor(country);
        } else { if(r.status===401){ invalidateAdminSession(); window.showError(UNAUTH_MSG); } else { window.showError('Failed to clear busy'); } }
      }catch(_){ window.showError('Network error'); }
    });

    // --- Client-side validation & dedup ---
    const ipv4Regex = /^(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)\.(25[0-5]|2[0-4]\d|[01]?\d\d?)$/;
    const ipPortRegex = /^(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.(?:25[0-5]|2[0-4]\d|[01]?\d\d?):(\d{1,5})$/;
    function analyzeEntries(){
      const raw = addrEl.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const valid = [];
      const invalid = [];
      const seen = new Set();
      for(const s of raw){
        if(adminMode==='dns'){
          if(ipv4Regex.test(s)){ if(!seen.has(s)){ seen.add(s); valid.push(s); } } else { invalid.push(s); }
        } else if(adminMode==='wg'){
          const m = ipPortRegex.exec(s);
          const port = m ? Number(m[1]) : 0;
          if(m && port>=1 && port<=65535){ if(!seen.has(s)){ seen.add(s); valid.push(s); } } else { invalid.push(s); }
        } else { // apn domains
          if(domainRegex.test(s)){ if(!seen.has(s)){ seen.add(s); valid.push(s); } } else { invalid.push(s); }
        }
      }
      const label = adminMode==='dns' ? 'IPv4' : (adminMode==='wg' ? 'IP:PORT' : 'Domain');
      ipHelper.innerHTML = `Valid ${label}: <b>${valid.length}</b> | Invalid: <b>${invalid.length}</b> | Unique: <b>${valid.length}</b> <button type="button" id="btnClean" style="margin-inline-start:.5rem">Clean duplicates</button>`;
      const btn = document.getElementById('btnClean');
      if(btn){ btn.onclick = ()=>{ addrEl.value = valid.join('\n'); analyzeEntries(); } }
      return { valid, invalid };
    }
    addrEl.addEventListener('input', analyzeEntries);
    // guard submit
    document.getElementById('countryForm').addEventListener('submit', (e)=>{
      const { valid } = analyzeEntries();
      if(valid.length === 0){
        e.preventDefault();
        let msg = 'ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
        if(adminMode==='dns') msg = 'Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© IPv4 Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
        else if(adminMode==='wg') msg = 'Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Endpoint Ù…Ø¹ØªØ¨Ø± (IP:PORT) ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
        else msg = 'Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¯Ø§Ù…Ù†Ù‡ APN Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
        window.showError(msg);
      }
    }, { capture: true });

    // Mode switching
    // Domain validator for APN
    const domainRegex = /^(?=.{1,253}$)(?!-)(?:[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?\.)+[A-Za-z]{2,}$/;

    async function setAdminMode(mode){
      adminMode = mode;
      if(mode==='dns'){
        if(modeDnsBtn){ modeDnsBtn.classList.add('active'); modeDnsBtn.setAttribute('aria-selected','true'); }
        if(modeWgBtn){ modeWgBtn.classList.remove('active'); modeWgBtn.setAttribute('aria-selected','false'); }
        if(modeApnBtn){ modeApnBtn.classList.remove('active'); modeApnBtn.setAttribute('aria-selected','false'); }
        addrLabel.textContent = 'Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ IPv4 (Ù‡Ø± Ø®Ø· ÛŒÚ© Ø¢Ø¯Ø±Ø³)';
        addrEl.placeholder = '45.153.38.148\n46.33.136.18\n86.104.12.89';
      } else if(mode==='wg'){
        if(modeWgBtn){ modeWgBtn.classList.add('active'); modeWgBtn.setAttribute('aria-selected','true'); }
        if(modeDnsBtn){ modeDnsBtn.classList.remove('active'); modeDnsBtn.setAttribute('aria-selected','false'); }
        if(modeApnBtn){ modeApnBtn.classList.remove('active'); modeApnBtn.setAttribute('aria-selected','false'); }
        addrLabel.textContent = 'Wireguard Endpoints â€” IP:PORT (Ù‡Ø± Ø®Ø· ÛŒÚ© Endpoint)';
        addrEl.placeholder = '203.0.113.10:51820\n198.51.100.22:443\n192.0.2.7:12345';
      } else { // apn
        if(modeApnBtn){ modeApnBtn.classList.add('active'); modeApnBtn.setAttribute('aria-selected','true'); }
        if(modeDnsBtn){ modeDnsBtn.classList.remove('active'); modeDnsBtn.setAttribute('aria-selected','false'); }
        if(modeWgBtn){ modeWgBtn.classList.remove('active'); modeWgBtn.setAttribute('aria-selected','false'); }
        addrLabel.textContent = 'APN Domains (Ù‡Ø± Ø®Ø· ÛŒÚ© Ø¯Ø§Ù…Ù†Ù‡)';
        addrEl.placeholder = 'mci.net\nmtn.net\nipm.example\nexample.apn';
      }
      analyzeEntries();
      const prev = selEl.value;
      await populateCountries(true);
      const sel = selEl.value.trim();
      if(sel) loadStatsFor(sel).catch(()=>{});
    }
    if(modeDnsBtn) modeDnsBtn.addEventListener('click', ()=> setAdminMode('dns'));
    if(modeWgBtn) modeWgBtn.addEventListener('click', ()=> setAdminMode('wg'));
    if(modeApnBtn) modeApnBtn.addEventListener('click', ()=> setAdminMode('apn'));

    // Auto-init admin session UI
    (async function initAdmin(){
      const ses = localStorage.getItem('adminSession');
      if(ses){
        // Validate that session is still valid
        try{
          const probe = await fetch(`/auth/me?session=${encodeURIComponent(ses)}`, { headers: adminHeaders(false) });
          if(!probe.ok){ invalidateAdminSession(); return; }
        }catch(_){ invalidateAdminSession(); return; }
        loginSection.style.display='none';
        if(adminTabs) adminTabs.style.display='block';
        if(countryForm) countryForm.style.display='block';
        if(statsSection) statsSection.style.display='none';
        if(logoutBtn) logoutBtn.style.display='inline-block';
        // show gift and redeem sections
        const giftSec = document.getElementById('giftSection');
        if(giftSec) giftSec.style.display='block';
        const redeemSec = document.getElementById('redeemSection');
        if(redeemSec) redeemSec.style.display='block';
        const giftListSec = document.getElementById('giftListSection');
        if(giftListSec) giftListSec.style.display='block';
        await populateCountries();
        updateFormMode();
        // notify owner silently if admin reopened panel (optional)
        try{ await fetch('/admin/notify-login',{method:'POST',headers: adminHeaders(),body:JSON.stringify({session:ses})}); }catch(_e){}
      }
    })();

    // Balance management wiring
    (function(){
      const btn = document.getElementById('bal_apply');
      const chat = document.getElementById('bal_chat');
      const delta = document.getElementById('bal_delta');
      if(btn) btn.addEventListener('click', async ()=>{
        const s = localStorage.getItem('adminSession');
        const target_chat_id = chat.value.trim();
        const d = parseFloat(delta.value);
        if(!s) return window.showError('Admin session missing');
        if(!target_chat_id) return window.showError('chat_id Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        if(!Number.isFinite(d)) return window.showError('Ù…Ù‚Ø¯Ø§Ø± ØªØºÛŒÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
        try{
          const r = await fetch('/admin/balance-update',{method:'POST',headers: adminHeaders(),body: JSON.stringify({session:s, target_chat_id, delta:d})});
          if(r.ok){
            const j = await r.json();
            window.showMessage(`Balance updated.\nPrev: ${j.prev}$\nNext: ${j.next}$`,'Ù¾ÛŒØ§Ù…');
            delta.value='';
          } else {
            if(r.status===401){ invalidateAdminSession(); window.showError(UNAUTH_MSG); }
            else { window.showError('Failed to update balance'); }
          }
        }catch(_){ window.showError('Network error'); }
      });
    })();

    // --- Pricing management UI ---
    (function(){
      // Inject pricing controls below balance section for better UX
      const form = document.getElementById('countryForm');
      if(!form) return;
      const pricingBlock = document.createElement('div');
      pricingBlock.innerHTML = `
        <hr style="margin:1.25rem 0; border:none; border-top:1px solid rgba(255,255,255,0.15)">
        <h3 style="margin:.25rem 0 .5rem;">ØªÙ†Ø¸ÛŒÙ… Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ (USD)</h3>
        <div class="form-grid">
          <div class="form-col">
            <label class="lbl" for="price_dns">Ù‡Ø²ÛŒÙ†Ù‡ Ù‡Ø± Ø¢Ø¯Ø±Ø³ DNS</label>
            <input type="number" id="price_dns" placeholder="0.50" step="0.01" min="0" />
          </div>
          <div class="form-col">
            <label class="lbl" for="price_wg">Ù‡Ø²ÛŒÙ†Ù‡ Ù‡Ø± Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª WireGuard</label>
            <input type="number" id="price_wg" placeholder="1.00" step="0.01" min="0" />
          </div>
        </div>
        <div class="row end" style="margin-top:.5rem">
          <button type="button" id="price_load">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</button>
          <button type="button" id="price_save">Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</button>
        </div>
      `;
      form.appendChild(pricingBlock);

      const btnLoad = pricingBlock.querySelector('#price_load');
      const btnSave = pricingBlock.querySelector('#price_save');
      const dnsInput = pricingBlock.querySelector('#price_dns');
      const wgInput = pricingBlock.querySelector('#price_wg');

      async function loadPricing(){
        const s = localStorage.getItem('adminSession');
        if(!s){ window.showError('Admin session missing'); return; }
        try{
          const r = await fetch(`/admin/set-pricing?session=${encodeURIComponent(s)}`, { headers: adminHeaders(false) });
          if(r.ok){
            const j = await r.json();
            dnsInput.value = (j && typeof j.dns === 'number') ? j.dns.toFixed(2) : '0.50';
            wgInput.value = (j && typeof j.wg === 'number') ? j.wg.toFixed(2) : '1.00';
          } else {
            if(r.status===401){ invalidateAdminSession(); window.showError(UNAUTH_MSG); }
            else { window.showError('Failed to load pricing'); }
          }
        }catch(_){ window.showError('Network error'); }
      }

      async function savePricing(){
        const s = localStorage.getItem('adminSession');
        if(!s){ window.showError('Admin session missing'); return; }
        const dns = parseFloat(dnsInput.value);
        const wg = parseFloat(wgInput.value);
        if(!Number.isFinite(dns) || dns < 0) return window.showError('Ù‚ÛŒÙ…Øª DNS Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
        if(!Number.isFinite(wg) || wg < 0) return window.showError('Ù‚ÛŒÙ…Øª WireGuard Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
        try{
          const r = await fetch('/admin/set-pricing', { method:'POST', headers: adminHeaders(), body: JSON.stringify({ session: s, dns, wg }) });
          if(r.ok){
            const j = await r.json();
            window.showMessage(`Saved.\nDNS: ${j.dns.toFixed(2)}$\nWG: ${j.wg.toFixed(2)}$`,'Ù¾ÛŒØ§Ù…');
            dnsInput.value = j.dns.toFixed(2);
            wgInput.value = j.wg.toFixed(2);
          } else {
            if(r.status===401){ invalidateAdminSession(); window.showError(UNAUTH_MSG); }
            else { window.showError('Failed to save pricing'); }
          }
        }catch(_){ window.showError('Network error'); }
      }

      if(btnLoad) btnLoad.addEventListener('click', loadPricing);
      if(btnSave) btnSave.addEventListener('click', savePricing);

      // Auto-load when session is available and form is visible
      const observer = new MutationObserver(()=>{
        const visible = form.style.display !== 'none';
        if(visible){ loadPricing().catch(()=>{}); observer.disconnect(); }
      });
      observer.observe(form, { attributes: true, attributeFilter: ['style'] });
    })();

    // --- Admin Tabs wiring ---
    function showManage(){
      if(tabManage){ tabManage.classList.add('active'); tabManage.setAttribute('aria-selected','true'); }
      if(tabStats){ tabStats.classList.remove('active'); tabStats.setAttribute('aria-selected','false'); }
      if(countryForm) countryForm.style.display='block';
      if(statsSection) statsSection.style.display='none';
    }
    function showStats(){
      if(tabStats){ tabStats.classList.add('active'); tabStats.setAttribute('aria-selected','true'); }
      if(tabManage){ tabManage.classList.remove('active'); tabManage.setAttribute('aria-selected','false'); }
      if(countryForm) countryForm.style.display='none';
      if(statsSection) statsSection.style.display='block';
      loadAdminUsers().catch(()=>{});
    }
    if(tabManage) tabManage.addEventListener('click', showManage);
    if(tabStats) tabStats.addEventListener('click', showStats);
    if(statsRefresh) statsRefresh.addEventListener('click', ()=> loadAdminUsers());
  </script>
</body>
</html>
