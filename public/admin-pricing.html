<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Pricing</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>Pricing Settings</h1>
    <a href="admin.html" class="admin-btn">← Back to Admin</a>
  </header>

  <!-- Global glassy error modal -->
  <div class="alert-overlay" id="alertOverlay"></div>
  <div class="alert-container" id="alertContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
      <div class="hdr">
        <div class="ttl" id="alertTitle">خطا</div>
        <button class="btn-close" id="alertX">×</button>
      </div>
      <div class="msg" id="alertMsg"></div>
      <div class="actions">
        <button class="btn-close" id="alertOk">باشه</button>
      </div>
    </div>
  </div>

  <div class="admin-container">
    <div id="loginSection">
      <label for="chat_id" class="lbl">Admin ID</label>
      <input type="number" id="chat_id" placeholder="e.g. 123456789" required />
      <div class="row">
        <button id="sendCodeBtn">Send Code</button>
        <input type="number" id="otp" placeholder="Enter OTP" style="display:none" />
        <button id="verifyBtn" style="display:none">Verify</button>
      </div>
    </div>

    <form id="pricingForm" style="display:none">
      <h3 style="margin:.25rem 0 .5rem;">تنظیم هزینه‌ها (USD)</h3>
      <div class="form-grid">
        <div class="form-col">
          <label class="lbl" for="price_dns">DNS — هزینه هر آدرس</label>
          <input type="number" id="price_dns" placeholder="0.50" step="0.01" />
        </div>
        <div class="form-col">
          <label class="lbl" for="price_wg">WireGuard — هزینه هر اندپوینت</label>
          <input type="number" id="price_wg" placeholder="1.00" step="0.01" />
        </div>
      </div>
      <div class="row end" style="margin-top:.5rem">
        <button type="button" id="price_load">بارگذاری قیمت‌ها</button>
        <button type="button" id="price_save">ذخیره قیمت‌ها</button>
      </div>
    </form>
  </div>

  <script>
    // Error/Message modal helper
    (function(){
      const overlay = document.getElementById('alertOverlay');
      const container = document.getElementById('alertContainer');
      const titleEl = document.getElementById('alertTitle');
      const msgEl = document.getElementById('alertMsg');
      const okBtn = document.getElementById('alertOk');
      const xBtn = document.getElementById('alertX');
      function close(){ overlay.classList.remove('active'); container.classList.remove('active'); }
      function open(title, message, asHtml){
        titleEl.textContent = title || 'پیام';
        if(asHtml){ msgEl.innerHTML = message || ''; }
        else { msgEl.textContent = message || ''; }
        overlay.classList.add('active');
        container.classList.add('active');
      }
      function showError(message, title){
        open(title || 'خطا', message, false);
      }
      function showMessage(message, title){
        const html = String(message||'').replace(/\n/g,'<br>');
        open(title || 'پیام', html, true);
      }
      okBtn.addEventListener('click', close);
      xBtn.addEventListener('click', close);
      overlay.addEventListener('click', close);
      window.showError = showError;
      window.showMessage = showMessage;
    })();

    const chatInput=document.getElementById('chat_id');
    const otpInput=document.getElementById('otp');
    const sendBtn=document.getElementById('sendCodeBtn');
    const verifyBtn=document.getElementById('verifyBtn');
    const loginSection=document.getElementById('loginSection');
    const form=document.getElementById('pricingForm');
    const elDns=document.getElementById('price_dns');
    const elWg=document.getElementById('price_wg');
    const btnLoad=document.getElementById('price_load');
    const btnSave=document.getElementById('price_save');

    chatInput.value = localStorage.getItem('adminChatId') || '';

    sendBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const chat_id=chatInput.value.trim();
      if(!chat_id) return window.showError('Enter ID');
      localStorage.setItem('adminChatId', chat_id);
      try{
        const r = await fetch('/auth/send-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id})});
        if(r.ok){
          window.showMessage('کد ارسال شد. اگر پیام نگرفتید، ابتدا در ربات Start را بزنید و مجدد تلاش کنید.','پیام');
          otpInput.style.display='block';
          verifyBtn.style.display='inline-block';
        } else {
          window.showError('Error sending code');
        }
      }catch(_){ window.showError('Network error'); }
    });

    verifyBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const chat_id=chatInput.value.trim();
      const code=otpInput.value.trim();
      if(!code) return window.showError('Enter code');
      try{
        const r = await fetch('/auth/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id,code})});
        if(r.ok){
          const {session} = await r.json();
          localStorage.setItem('adminSession', session);
          loginSection.style.display='none';
          form.style.display='block';
          await load();
        } else {
          window.showError('Verification failed');
        }
      }catch(_){ window.showError('Network error'); }
    });

    async function load(){
      const s = localStorage.getItem('adminSession');
      if(!s) return window.showError('Admin session missing');
      try{
        const r = await fetch(`/admin/set-pricing?session=${encodeURIComponent(s)}`);
        if(r.ok){
          const j = await r.json();
          elDns.value = (j.dns!=null? j.dns : 0.5);
          elWg.value = (j.wg!=null? j.wg : 1.0);
        } else {
          window.showError('Failed to load pricing');
        }
      }catch(_){ window.showError('Network error'); }
    }

    async function save(){
      const s = localStorage.getItem('adminSession');
      if(!s) return window.showError('Admin session missing');
      const dns = parseFloat(elDns.value);
      const wg = parseFloat(elWg.value);
      if(!(Number.isFinite(dns) && dns>=0)) return window.showError('قیمت DNS نامعتبر است');
      if(!(Number.isFinite(wg) && wg>=0)) return window.showError('قیمت WG نامعتبر است');
      try{
        const r = await fetch('/admin/set-pricing',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ session:s, dns, wg }) });
        if(r.ok){
          const j = await r.json();
          window.showMessage(`Saved. DNS: $${j.dns.toFixed(2)} | WG: $${j.wg.toFixed(2)}`,'پیام');
        } else {
          window.showError('Failed to save pricing');
        }
      }catch(_){ window.showError('Network error'); }
    }

    if(btnLoad) btnLoad.addEventListener('click', load);
    if(btnSave) btnSave.addEventListener('click', save);

    (async function init(){
      const ses = localStorage.getItem('adminSession');
      if(ses){
        loginSection.style.display='none';
        form.style.display='block';
        await load();
      }
    })();
  </script>
</body>
</html>
