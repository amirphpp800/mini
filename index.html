<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pro TooLs — Countries</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&family=Vazirmatn:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="Logo/Logo.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="public/styles.css" />
</head>
<body>
  <canvas id="bg-net"></canvas>
  <header>
    <div class="brand">
      <img class="brand-logo" src="Logo/Logo.svg" alt="Pro TooLs logo" />
      <span class="brand-name">Pro TooLs</span>
    </div>
    <div class="actions">
      <a href="public/admin.html" class="admin-btn"><span class="btn-ico" aria-hidden="true">
        <!-- Lucide settings cog icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.7 0 1.27.3 1.51 1H21a2 2 0 1 1 0 4h-.09c-.24.7-.81 1-1.51 1Z"/></svg>
      </span>Admin Panel</a>
      <button id="openSignup" class="primary-btn accent-btn"><span class="btn-ico" aria-hidden="true">
        <!-- Lucide user-round icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/></svg>
      </span><span id="openSignupLabel">Create Account</span></button>
      <a href="public/buy.html" class="primary-btn usdt-btn" style="text-decoration:none;"><span class="btn-ico" aria-hidden="true">
        <!-- High quality dollar/money icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>
      </span>Buy USDT</a>
    </div>
  </header>
  <div class="tabs" role="tablist" aria-label="Dataset Tabs">
    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
      <span>DNS</span>
      <div class="mobile-menu-icon">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
    <div class="tab-list">
      <button class="tab active" id="tab-dns" role="tab" aria-selected="true" aria-controls="panel-dns"><img src="public/dns.png" alt="" aria-hidden="true"/> DNS</button>
      <button class="tab" id="tab-wg" role="tab" aria-selected="false" aria-controls="panel-wg"><img src="public/wireguard.svg" alt="" aria-hidden="true"/> Wireguard Endpoint</button>
      <button class="tab" id="tab-apn" type="button" aria-selected="false" title="APN"> 
        <img src="public/apn.svg" alt="" aria-hidden="true"/>
        APN
      </button>
      <button class="tab" id="tab-android" type="button" aria-selected="false" title="Android Settings">
        <img src="public/android.svg" alt="" aria-hidden="true"/>
        Android Settings
      </button>
      <button class="tab" id="tab-ios" type="button" aria-selected="false" title="iPhone Settings">
        <img src="public/apple.svg" alt="" aria-hidden="true"/>
        iPhone Settings
      </button>
    </div>
  </div>

  <!-- Mobile Menu Modal -->
  <div class="mobile-menu-modal" id="mobile-menu-modal">
    <div class="mobile-menu-content">
      <div class="mobile-menu-header">
        <div class="mobile-menu-title">انتخاب نوع سرویس</div>
        <button class="mobile-menu-close" id="mobile-menu-close">×</button>
      </div>
      <div class="mobile-menu-tabs">
        <button class="tab active" data-tab="dns"><img src="public/dns.png" alt="" aria-hidden="true"/> DNS</button>
        <button class="tab" data-tab="wg"><img src="public/wireguard.svg" alt="" aria-hidden="true"/> Wireguard Endpoint</button>
        <button class="tab" data-tab="apn"><img src="public/apn.svg" alt="" aria-hidden="true"/> APN</button>
        <button class="tab" data-tab="android"><img src="public/android.svg" alt="" aria-hidden="true"/> Android Settings</button>
        <button class="tab" data-tab="ios"><img src="public/apple.svg" alt="" aria-hidden="true"/> iPhone Settings</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="accOverlay"></div>
  <div class="modal-container" id="accModal">
    <section id="account" class="account-panel" role="dialog" aria-modal="true" aria-labelledby="accTitle">
      <button class="modal-close" id="closeSignup" aria-label="Close">×</button>
      <h2 id="accTitle">User Account</h2>
      <div class="status-line" id="accStatus">Checking status...</div>
      <div class="row" id="u_balance_row" style="display:none">
        <div class="muted">Balance: <span id="u_balance_value">$0.00</span></div>
      </div>
      <div class="row" id="u_tg_row">
        <a class="tg-btn" href="tg://resolve?domain=minidnsverify_bot">Start Telegram Bot</a>
      </div>
      <div class="row" id="u_chat_row">
        <input type="number" id="u_chat_id" placeholder="Telegram ID" />
        <button id="u_send">Send Code</button>
      </div>
      <div class="row" id="u_otp_row" style="display:none">
        <input type="number" id="u_otp" placeholder="Enter verification code" />
        <button id="u_verify">Verify</button>
      </div>
      <div class="row" id="u_logged" style="display:none">
        <span>Logged in</span>
        <button id="u_logout">Logout</button>
      </div>
      <div class="row" id="u_id_row" style="display:none">
        <div class="muted">Your ID: <span id="u_id_value"></span></div>
      </div>
      <div id="u_history_wrap" style="display:none; margin-top: .75rem;">
        <div class="lbl" style="margin:.25rem 0">Your fetched addresses</div>
        <p class="muted glass-note">از طریق داشبورد حساب کاربری می‌توانید به آدرس‌های دریافت‌شده خود دسترسی داشته باشید و دوباره آن‌ها را مشاهده یا کپی کنید.</p>
        <div id="u_history" style="display:flex;flex-direction:column;gap:.5rem;"></div>
      </div>
      <small id="u_tg_hint">If you didn’t receive a message, open the Telegram bot below, press Start, then try again:
        <a href="https://t.me/minidnsverify_bot" target="_blank" rel="noopener" style="color:#7fd1ff">@minidnsverify_bot</a>
      </small>
    </section>
  </div>
  <!-- Global glassy error modal -->
  <div class="alert-overlay" id="alertOverlay"></div>
  <div class="alert-container" id="alertContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
      <div class="hdr">
        <div class="ttl" id="alertTitle">خطا</div>
        <button class="btn-close" id="alertX">×</button>
      </div>
      <div class="msg" id="alertMsg"></div>
      <div class="actions">
        <button class="btn-close" id="alertOk">OK</button>
      </div>
    </div>
  </div>
  <!-- Address modal (for showing fetched IPs with Copy and auto-refresh on close) -->
  <div class="alert-overlay" id="addrOverlay"></div>
  <div class="alert-container" id="addrContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="addrTitle">
      <div class="hdr">
        <div class="ttl" id="addrTitle">آدرس‌های شما</div>
        <button class="btn-close" id="addrX">×</button>
      </div>
      <div class="msg" id="addrMsg" style="white-space: pre-wrap; direction: ltr;"></div>
      <div class="actions">
        <button id="addrCopy">
          <span class="btn-ico" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M16 4v6a2 2 0 0 1-2 2H6"/><rect width="12" height="12" x="2" y="8" rx="2"/></svg>
          </span>
          <span class="btn-label">Copy</span>
        </button>
        <button id="addrCheck" class="alt-btn">
          <span class="btn-ico" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h3l2 7 4-14 2 7h7"/></svg>
          </span>
          <span class="btn-label">Ping Check</span>
        </button>
        <button class="btn-close" id="addrOk">OK</button>
      </div>
    </div>
  </div>
  <!-- Confirm modal (glassy) -->
  <div class="alert-overlay" id="confirmOverlay"></div>
  <div class="alert-container" id="confirmContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="hdr">
        <div class="ttl" id="confirmTitle">تایید</div>
        <button class="btn-close" id="confirmX">×</button>
      </div>
      <div class="msg" id="confirmMsg"></div>
      <div class="actions">
        <button id="confirmNo">Cancel</button>
        <button id="confirmYes" class="primary-btn">Confirm</button>
      </div>
    </div>
  </div>
  <main id="cards"></main>
  <div class="pagination" id="pagination">
    <button class="page-btn" id="prevPage">Prev</button>
    <span class="page-info" id="pageInfo">Page 1 / 1</span>
    <button class="page-btn" id="nextPage">Next</button>
  </div>
  <script>
    // --- Error/Message modal helper ---
    (function(){
      const overlay = document.getElementById('alertOverlay');
      const container = document.getElementById('alertContainer');
      const titleEl = document.getElementById('alertTitle');
      const msgEl = document.getElementById('alertMsg');
      const okBtn = document.getElementById('alertOk');
      const xBtn = document.getElementById('alertX');
      function close(){ overlay.classList.remove('active'); container.classList.remove('active'); }
      function open(title, message, asHtml){
        titleEl.textContent = title || 'پیام';
        if(asHtml){ msgEl.innerHTML = message || ''; }
        else { msgEl.textContent = message || ''; }
        overlay.classList.add('active');
        container.classList.add('active');
      }
      function showError(message, title){ open(title || 'خطا', message, false); }
      function showMessage(message, title){
        const html = String(message||'').replace(/\n/g,'<br>');
        open(title || 'پیام', html, true);
      }
      okBtn.addEventListener('click', close);
      xBtn.addEventListener('click', close);
      overlay.addEventListener('click', close);
      window.showError = showError;
      window.showMessage = showMessage;
    })();
    // --- Confirm modal helper ---
    (function(){
      const overlay = document.getElementById('confirmOverlay');
      const container = document.getElementById('confirmContainer');
      const titleEl = document.getElementById('confirmTitle');
      const msgEl = document.getElementById('confirmMsg');
      const yesBtn = document.getElementById('confirmYes');
      const noBtn = document.getElementById('confirmNo');
      const xBtn = document.getElementById('confirmX');

      let resolver = null;
      function close(){ overlay.classList.remove('active'); container.classList.remove('active'); }
      function open(message, title){
        titleEl.textContent = title || 'تایید';
        msgEl.textContent = message || '';
        overlay.classList.add('active');
        container.classList.add('active');
      }
      function resolve(val){ if(resolver){ const r=resolver; resolver=null; r(val); } close(); }
      if(yesBtn) yesBtn.onclick = ()=> resolve(true);
      if(noBtn) noBtn.onclick = ()=> resolve(false);
      if(xBtn) xBtn.onclick = ()=> resolve(false);
      if(overlay) overlay.onclick = ()=> resolve(false);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay && overlay.classList.contains('active')) resolve(false); });

      function showConfirm(message, title){
        return new Promise((resolveFn)=>{ resolver = resolveFn; open(message, title); });
      }
      window.showConfirm = showConfirm;
    })();
    // --- Address modal helper ---
    (function(){
      const overlay = document.getElementById('addrOverlay');
      const container = document.getElementById('addrContainer');
      const msgEl = document.getElementById('addrMsg');
      const copyBtn = document.getElementById('addrCopy');
      const checkBtn = document.getElementById('addrCheck');
      const okBtn = document.getElementById('addrOk');
      const xBtn = document.getElementById('addrX');

      function close(){
        overlay.classList.remove('active');
        container.classList.remove('active');
        // Refresh page so the assigned IPs move to busy list
        location.reload();
      }
      function showAddressModal(addresses){
        const text = (addresses||[]).join('\n');
        // Determine first host for external check (strip port if present)
        const firstRaw = (addresses&&addresses[0]) ? String(addresses[0]).trim() : '';
        let hostToCheck = firstRaw;
        const ipPortMatch = /^([^\s:]+):(\d{1,5})$/.exec(firstRaw);
        if(ipPortMatch){ hostToCheck = ipPortMatch[1]; }
        // Compose content: addresses + optional DNS note
        let html = `<pre style="white-space:pre-wrap;direction:ltr;margin:0 0 .75rem 0;">${text.replace(/</g,'&lt;')}</pre>`;
        if (window.state && window.state.currentTab === 'dns'){
          html += `
          <div class="glass-note persian-text" lang="fa" style="text-align:right; line-height:1.5">
            <div style="font-weight:800;margin-bottom:.2rem">لیست سرورهایی که آدرس خود را می‌توانید تانل کنید:</div>
            <div>
              گوگل<br/>
              8.8.8.8<br/>
              8.8.4.4
            </div>
            <div style="opacity:.5;margin:.2rem 0">➖➖➖➖➖➖</div>
            <div>
              کلودفلر<br/>
              1.1.1.1<br/>
              1.0.0.1
            </div>
            <div style="opacity:.5;margin:.2rem 0">➖➖➖➖➖➖</div>
            <div>
              رادار گیم<br/>
              10.202.10.10<br/>
              10.202.10.11
            </div>
            <div style="opacity:.5;margin:.2rem 0">➖➖➖➖➖➖</div>
            <div>
              الکترو<br/>
              78.157.42.100<br/>
              78.157.42.101
            </div>
            <div style="opacity:.5;margin:.2rem 0">➖➖➖➖➖➖</div>
            <div>
              اوپن دی‌ان‌اس<br/>
              208.67.222.222<br/>
              208.67.220.220
            </div>
            <div style="opacity:.5;margin:.2rem 0">➖➖➖➖➖➖</div>
            <div>
              شِکن رایگان<br/>
              178.22.122.100<br/>
              185.51.200.2
            </div>
            <div style="opacity:.5;margin:.2rem 0">➖➖➖➖➖➖</div>
            <div>
              شِکن پرو<br/>
              178.22.122.101<br/>
              185.51.200.1
            </div>
          </div>`;
        }
        msgEl.innerHTML = html;
        overlay.classList.add('active');
        container.classList.add('active');
        // Handlers
        copyBtn.onclick = async ()=>{
          try{
            await navigator.clipboard.writeText(text);
            const lbl = copyBtn.querySelector('.btn-label');
            if(lbl){ lbl.textContent = 'Copied!'; setTimeout(()=>{ lbl.textContent = 'Copy'; }, 1500); }
          }catch(_e){}
        };
        if(checkBtn){
          checkBtn.onclick = ()=>{
            if(!hostToCheck) return;
            const url = `https://check-host.net/check-ping?host=${encodeURIComponent(hostToCheck)}`;
            window.open(url, '_blank', 'noopener');
          };
        }
        okBtn.onclick = close;
        xBtn.onclick = close;
        overlay.onclick = close;
      }
      window.showAddressModal = showAddressModal;
    })();
    // simple mapper to Persian names
    function nameToFa(name){
      const map = {
        'england': 'انگلیس',
        'united kingdom': 'بریتانیا',
        'uk': 'بریتانیا',
        'great britain': 'بریتانیا'
      };
      const key = String(name||'').toLowerCase();
      return map[key] || '';
    }
    const isLocal = /^(localhost|127\.0\.0\.1)/.test(location.hostname);
    // Tab and pagination state
    const pageSize = 14;
    // Load persisted UI state
    const savedTab = (localStorage.getItem('ui.currentTab')||'dns');
    let savedPages = {};
    try{ savedPages = JSON.parse(localStorage.getItem('ui.pages')||'{}')||{}; }catch(_){ savedPages = {}; }
    const state = {
      currentTab: savedTab || 'dns',
      page: { dns: Number(savedPages.dns)||1, wg: Number(savedPages.wg)||1, apn: Number(savedPages.apn)||1 },
      data: { dns: [], wg: [], apn: [] }
    };
    // expose for other utilities (e.g., showAddressModal)
    window.state = state;

    async function fetchDataset(kind){
      try{
        // Try dynamic endpoints first for DNS; for WG keep static for now
        if(kind==='dns'){
          try{
            const r = await fetch('/countries');
            if(r.ok) return await r.json();
          }catch(_){/* fallthrough */}
          const rl = await fetch('public/countries.json');
          return await rl.json();
        } else {
          try{
            const r2 = await fetch('/wireguard-countries');
            if(r2.ok){
              const j = await r2.json();
              // If backend returns an empty list, fall back to local static file
              if(Array.isArray(j) && j.length>0) return j;
            }
          }catch(_){/* fallthrough */}
          const rl2 = await fetch('public/wireguard-countries.json');
          return await rl2.json();
        }
      }catch(e){ return []; }
    }

    function renderPage(){
      const container = document.getElementById('cards');
      // reset container layout (in case APN altered it previously)
      container.style.display='';
      container.style.alignItems='';
      container.style.justifyContent='';

      // Special unified view for APN
      if(state.currentTab === 'apn'){
        // hide pagination in APN tab
        const pEl = document.getElementById('prevPage');
        const nEl = document.getElementById('nextPage');
        const iEl = document.getElementById('pageInfo');
        if(pEl&&nEl&&iEl){ pEl.style.display='none'; nEl.style.display='none'; iEl.style.display='none'; }

        // center container and enlarge card
        container.innerHTML = '';
        container.style.display='flex';
        container.style.alignItems='center';
        container.style.justifyContent='center';
        const card = document.createElement('div');
        card.className = 'glass-card';
        card.style.textAlign = 'center';
        card.style.maxWidth = '760px';
        card.style.width = '100%';
        card.style.margin = '0 auto';
        card.style.padding = '2rem';

        const h2 = document.createElement('h2');
        h2.textContent = 'APN Service';
        const sub = document.createElement('div');
        sub.className = 'subtitle-fa persian-text';
        sub.textContent = 'وضعیت APN بر اساس کشور';
        card.appendChild(h2);
        card.appendChild(sub);

        // country selector
        const row = document.createElement('div');
        row.className = 'row';
        row.style.justifyContent='center';
        row.style.gap = '.5rem';
        const sel = document.createElement('select');
        sel.id = 'apnCountry';
        sel.style.minWidth='220px';
        sel.style.background = '#000';
        sel.style.color = '#fff';
        sel.style.border = '1px solid rgba(255,255,255,0.3)';
        sel.style.borderRadius = '12px';
        sel.style.padding = '.65rem 1rem';
        sel.style.fontWeight = '600';
        row.appendChild(sel);
        // placeholder
        const ph = document.createElement('option');
        ph.value = '';
        ph.textContent = '— انتخاب کشور —';
        sel.appendChild(ph);
        let apnCountries = [];
        card.appendChild(row);

        // black details panel with flag and random speed
        const details = document.createElement('div');
        details.className = 'apn-speed';
        details.style.marginTop = '1rem';
        details.style.background = '#000';
        details.style.color = '#fff';
        details.style.border = '1px solid rgba(255,255,255,0.18)';
        details.style.borderRadius = '16px';
        details.style.padding = '1rem';
        details.style.display = 'flex';
        details.style.alignItems = 'center';
        details.style.justifyContent = 'center';
        details.style.flexDirection = 'column';
        details.style.gap = '1rem';

        function randomSpeed(){
          return (Math.random() * 80 + 20).toFixed(1); // 20.0 - 100.0 Mbps
        }
        function countryInfoByName(name){
          const c = (apnCountries||[]).find(x=> String(x.name).toLowerCase() === String(name||'').toLowerCase());
          return c || { name, code: 'gb', faName: name };
        }
        function flagUrl(code){
          const cc = String(code||'gb').toLowerCase();
          return `https://flagcdn.com/w40/${cc}.png`;
        }
        function renderDetails(){
          const cval = sel.value;
          const ci = countryInfoByName(cval);
          const spd = randomSpeed();
          const mbps = (Number(spd)/8).toFixed(2);
          details.innerHTML = '';
          const img = new Image();
          img.src = flagUrl(ci.code);
          img.alt = `${ci.name} flag`;
          img.width = 48; img.height = 32; img.style.borderRadius = '6px'; img.loading = 'lazy';
          img.style.boxShadow = '0 6px 18px rgba(0,0,0,0.35)';
          const textBox = document.createElement('div');
          textBox.innerHTML = `<div class="persian-text" lang="fa" style="font-weight:800">${ci.faName||ci.name}</div>
                               <div class="muted" style="margin-top:.15rem">میانگین سرعت لحظه‌ای:<br/><b>${spd} Mbps</b></div>
                               <div class="muted" style="margin-top:.1rem">معادل مگابایت بر ثانیه:<br/><b>${mbps} MB/s</b></div>`;
          details.appendChild(img);
          details.appendChild(textBox);
        }
        renderDetails();
        card.appendChild(details);

        // counters
        const counters = document.createElement('div');
        counters.className = 'counters';
        counters.innerHTML = `
          <div class="count total"><div class="num">0</div><div class="lbl-en">Total APNs</div></div>
          <div class="count free"><div class="num">0</div><div class="lbl-en">Available</div></div>
          <div class="count busy"><div class="num">0</div><div class="lbl-en">In Use</div></div>`;
        card.appendChild(counters);

        // purchase button
        const btn = document.createElement('button');
        btn.className = 'get-btn';
        btn.textContent = 'Get APN ($1.5)';
        btn.addEventListener('click', async ()=>{
          const country = sel.value;
          const session = localStorage.getItem('userSession');
          if(!session){ if (window.openSignupModal) window.openSignupModal(); else window.showError('Please verify your account first.'); return; }
          try{
            // pricing
            let price = 1.5;
            try{ const rp=await fetch('/pricing'); if(rp.ok){ const pj=await rp.json(); if(pj&&pj.apn!=null) price=Number(pj.apn)||1.5; } }catch(_){ }
            // balance
            let currentBal = null;
            try{ const rb = await fetch('/user/balance', { headers:{ 'Authorization': `Bearer ${session}` } }); if(rb.ok){ const bj=await rb.json(); currentBal = parseFloat(bj.balance); } }catch(_){ }
            if(currentBal != null && Number.isFinite(currentBal)){
              const after = +((currentBal - (Number(price)||0))).toFixed(2);
              if((Number(price)||0)>0){
                if(currentBal < price){ window.showError(`موجودی فعلی شما $${currentBal.toFixed(2)} است و برای این عملیات $${Number(price).toFixed(2)} نیاز است. لطفاً برای افزایش موجودی با ادمین تماس بگیرید: @Minimalcraft`, 'موجودی کافی نیست'); return; }
                const ok = await window.showConfirm(`هزینه این درخواست: $${Number(price).toFixed(2)}\nموجودی فعلی: $${currentBal.toFixed(2)}\nموجودی پس از کسر: $${after.toFixed(2)}\nآیا تایید می‌کنید؟`, 'تایید کسر موجودی');
                if(!ok) return;
              }
            }
            const r = await fetch(`/apn/${encodeURIComponent(country.toLowerCase())}`, { headers:{ 'Authorization': `Bearer ${session}` } });
            if(!r.ok){ if(r.status===402){ window.showError('موجودی کافی نیست', 'موجودی کافی نیست'); } else { window.showError('Failed to fetch APN'); } return; }
            const { apn=[] } = await r.json();
            if(!apn || apn.length===0){ window.showError('No APN available yet.'); return; }
            // show simple modal list (reuse address modal presenter)
            if(window.showAddressModal) window.showAddressModal(apn);
            // refresh counters after
            loadStats(sel.value);
          }catch(e){ console.error(e); window.showError('Network error while fetching APN'); }
        });
        card.appendChild(btn);

        container.appendChild(card);

        async function loadStats(country){
          try{
            if(isLocal) return;
            const r = await fetch(`/apn-stats/${encodeURIComponent(country)}`);
            if(r.ok){ const s = await r.json();
              card.querySelector('.total .num').textContent = s.total;
              card.querySelector('.free .num').textContent = s.free;
              card.querySelector('.busy .num').textContent = s.busy;
            }
          }catch(_){ }
        }
        // Load APN-enabled countries dynamically
        (async ()=>{
          try{
            const r = await fetch('/apn-countries');
            if(r.ok){
              apnCountries = await r.json();
            } else { apnCountries = []; }
          }catch(_){ apnCountries = []; }
          // Fallback to a small default list if backend has no APN countries yet
          if(!Array.isArray(apnCountries) || apnCountries.length === 0){
            apnCountries = [
              { name: 'China', faName: 'چین', code: 'cn' },
              { name: 'England', faName: 'انگلیس', code: 'gb' },
              { name: 'Germany', faName: 'آلمان', code: 'de' },
              { name: 'United Arab Emirates', faName: 'امارات', code: 'ae' },
              { name: 'Qatar', faName: 'قطر', code: 'qa' }
            ];
          }
          // fill select
          sel.innerHTML = '';
          const ph2 = document.createElement('option');
          ph2.value=''; ph2.textContent='— انتخاب کشور —';
          sel.appendChild(ph2);
          (apnCountries||[]).forEach(c=>{
            const opt=document.createElement('option');
            opt.value=c.name;
            opt.textContent=(c.faName&&c.faName.trim())? c.faName : c.name;
            sel.appendChild(opt);
          });
          // auto-select first country if available
          if(sel.options.length>1){ sel.selectedIndex = 1; }
          renderDetails();
          if(sel.value) loadStats(sel.value);
        })();
        sel.addEventListener('change', ()=> { loadStats(sel.value); renderDetails(); });

        return; // stop normal rendering path for APN
      }

      // default list rendering for DNS/WG
      // show pagination again (it was hidden in APN view)
      (function(){
        const pEl = document.getElementById('prevPage');
        const nEl = document.getElementById('nextPage');
        const iEl = document.getElementById('pageInfo');
        if(pEl&&nEl&&iEl){ pEl.style.display=''; nEl.style.display=''; iEl.style.display=''; }
      })();
      const list = state.data[state.currentTab] || [];
      const totalPages = Math.max(1, Math.ceil(list.length / pageSize));
      let page = state.page[state.currentTab] || 1;
      if(page>totalPages) page = totalPages; if(page<1) page = 1; state.page[state.currentTab]=page;

      const start = (page-1)*pageSize;
      const slice = list.slice(start, start + pageSize);
      container.innerHTML = '';

      slice.forEach(c => {
        const card = document.createElement('div');
        card.className = 'glass-card';
        const code = String((c && c.code) || '').toLowerCase() || 'gb';
        const img = new Image();
        img.alt = `${c.name} flag`;
        img.loading = 'lazy';
        img.src = `https://flagcdn.com/w160/${code}.png`;
        img.srcset = `https://flagcdn.com/w320/${code}.png 2x`;
        img.referrerPolicy = 'no-referrer';
        img.className = 'flag-img';
        card.appendChild(img);

        const title = document.createElement('h2');
        title.textContent = c.name || '';
        card.appendChild(title);
        const sub = document.createElement('div');
        sub.className = 'subtitle-fa';
        sub.textContent = c.faName || nameToFa(c.name) || '';
        if (sub.textContent) card.appendChild(sub);

        const counters = document.createElement('div');
        counters.className = 'counters';
        if(state.currentTab==='apn'){
          counters.innerHTML = `
            <div class="count total"><div class="num">0</div><div class="lbl-en">Total APNs</div></div>
            <div class="count free"><div class="num">0</div><div class="lbl-en">Available</div></div>
            <div class="count busy"><div class="num">0</div><div class="lbl-en">In Use</div></div>`;
        } else {
          counters.innerHTML = `
            <div class="count total"><div class="num">0</div><div class="lbl-en">Total IPs</div></div>
            <div class="count free"><div class="num">0</div><div class="lbl-en">Free</div></div>
            <div class="count busy"><div class="num">0</div><div class="lbl-en">Busy</div></div>`;
        }
        card.appendChild(counters);

        const btn = document.createElement('button');
        btn.className = 'get-btn';
        if(state.currentTab==='apn'){
          btn.textContent = 'Get APN ($1.5)';
        } else {
          btn.textContent = state.currentTab==='dns' ? 'Get Addresses' : 'Get Endpoints';
        }
        btn.addEventListener('click', async ()=>{
          const session = localStorage.getItem('userSession');
          if(!session){
            if (window.openSignupModal) window.openSignupModal();
            else window.showError('Please verify your account first.');
            return;
          }
          try{
            // Pre-confirm: read pricing and current balance, ask user for approval
            let price = 0;
            try{
              const rp = await fetch('/pricing');
              if(rp.ok){
                const pj = await rp.json();
                if(state.currentTab==='dns') price = pj.dns ?? 0.5;
                else if(state.currentTab==='wg') price = pj.wg ?? 1.0;
                else if(state.currentTab==='apn') price = pj.apn ?? 1.5;
              }
            }catch(_){/* ignore */}
            let currentBal = null;
            try{
              const rb = await fetch('/user/balance', { headers:{ 'Authorization': `Bearer ${session}` } });
              if(rb.ok){ const bj = await rb.json(); currentBal = parseFloat(bj.balance); }
            }catch(_){/* ignore */}
            if(currentBal != null && Number.isFinite(currentBal)){
              const after = +((currentBal - (Number(price)||0))).toFixed(2);
              if((Number(price)||0) > 0){
                if(currentBal < price){
                  window.showError(`موجودی فعلی شما $${currentBal.toFixed(2)} است و برای این عملیات $${Number(price).toFixed(2)} نیاز است. لطفاً برای افزایش موجودی با ادمین تماس بگیرید: @Minimalcraft`, 'موجودی کافی نیست');
                  return;
                }
                const ok = await window.showConfirm(`هزینه این درخواست: $${Number(price).toFixed(2)}\nموجودی فعلی: $${currentBal.toFixed(2)}\nموجودی پس از کسر: $${after.toFixed(2)}\nآیا تایید می‌کنید؟`, 'تایید کسر موجودی');
                if(!ok) return;
              }
            }
            let path;
            if(state.currentTab==='dns') path = `/addresses/${(c.name||'').toLowerCase()}`;
            else if(state.currentTab==='wg') path = `/wg/${(c.name||'').toLowerCase()}`;
            else if(state.currentTab==='apn') path = `/apn/${(c.name||'').toLowerCase()}`;
            const r = await fetch(path, { headers:{ 'Authorization': `Bearer ${session}` } });
            if(!r.ok){
              if(r.status===401||r.status===403){
                window.showError('Your session is invalid or unverified. Please verify again.');
              } else if(r.status===402){
                try{
                  const j = await r.json();
                  const needed = (j && j.needed!=null) ? j.needed : null;
                  const balance = (j && j.balance!=null) ? j.balance : null;
                  const msg = `موجودی حساب شما کافی نیست.${needed!=null? `\nمبلغ موردنیاز: $${Number(needed).toFixed(2)}`:''}${balance!=null? `\nموجودی فعلی: $${Number(balance).toFixed(2)}`:''}\nبرای افزایش موجودی به ادمین پیام دهید: @Minimalcraft`;
                  window.showError(msg, 'موجودی کافی نیست');
                }catch(_e){
                  window.showError('موجودی حساب شما کافی نیست. برای افزایش موجودی به ادمین پیام دهید: @Minimalcraft', 'موجودی کافی نیست');
                }
              } else {
                window.showError('Failed to fetch addresses');
              }
              return;
            }
            const { addresses=[] } = await r.json();
            if(addresses.length===0){ window.showError('No addresses available yet.'); return; }
            if(window.showAddressModal) window.showAddressModal(addresses);
            try{
              const key = 'userAddrHistory';
              const hist = JSON.parse(localStorage.getItem(key) || '[]');
              const entry = { country: c.name, count: addresses.length, addresses, ts: Date.now(), type: state.currentTab };
              hist.unshift(entry);
              localStorage.setItem(key, JSON.stringify(hist.slice(0,20)));
              if(window.renderUserHistory) window.renderUserHistory();
            }catch(_e){}
            // Refresh balance after deduction
            try{
              const rb2 = await fetch('/user/balance', { headers:{ 'Authorization': `Bearer ${session}` } });
              if(rb2.ok){ const jb = await rb2.json(); const el = document.getElementById('u_balance_value'); if(el && jb && jb.balance!=null){ el.textContent = `$${jb.balance}`; }
                const balRow = document.getElementById('u_balance_row'); if(balRow) balRow.style.display='flex'; }
            }catch(_){/* ignore */}
          }catch(e){ console.error(e); window.showError('Network error while fetching addresses'); }
        });
        card.appendChild(btn);

        container.appendChild(card);

        // stats per country (skip local)
        async function loadStats(){
          try{
            if(isLocal) return;
            let endpoint;
            if(state.currentTab==='dns') endpoint = `/stats/${c.name}`;
            else if(state.currentTab==='wg') endpoint = `/wg-stats/${c.name}`;
            else if(state.currentTab==='apn') endpoint = `/apn-stats/${c.name}`;
            const r=await fetch(endpoint);
            if(r.ok){
              const s=await r.json();
              card.querySelector('.total .num').textContent=s.total;
              card.querySelector('.free .num').textContent=s.free;
              card.querySelector('.busy .num').textContent=s.busy;
            }
          }catch(e){}
        }
        loadStats();
        if(!isLocal) setInterval(loadStats,30000);
      });

      // update pagination UI
      const prev = document.getElementById('prevPage');
      const next = document.getElementById('nextPage');
      const info = document.getElementById('pageInfo');
      if(prev&&next&&info){
        info.textContent = `Page ${page} / ${totalPages}`;
        prev.disabled = page<=1;
        next.disabled = page>=totalPages;
      }
      // persist current page per tab
      try{
        const p = JSON.parse(localStorage.getItem('ui.pages')||'{}')||{};
        p[state.currentTab] = page;
        localStorage.setItem('ui.pages', JSON.stringify(p));
      }catch(_){ }
    }

    async function initDatasets(){
      state.data.dns = await fetchDataset('dns');
      try{ state.data.wg = await fetchDataset('wg'); }catch(_){ state.data.wg = []; }
      try{ state.data.apn = await fetchDataset('apn'); }catch(_){ state.data.apn = []; }

      // Sort by total IPs desc for better UX
      async function sortByTotals(kind){
        try{
          const list = Array.isArray(state.data[kind]) ? state.data[kind] : [];
          let base;
          if(kind==='dns') base = '/stats/';
          else if(kind==='wg') base = '/wg-stats/';
          else if(kind==='apn') base = '/apn-stats/';
          const totals = await Promise.allSettled(list.map(async (c)=>{
            const name = c && c.name ? String(c.name) : '';
            if(!name) return { name: '', total: 0 };
            try{
              const r = await fetch(base + encodeURIComponent(name));
              if(r && r.ok){ const s = await r.json(); return { name, total: Number(s && s.total || 0) }; }
            }catch(__){}
            return { name, total: 0 };
          }));
          const totalMap = new Map();
          for(const t of totals){ if(t.status==='fulfilled' && t.value && t.value.name){ totalMap.set(t.value.name, t.value.total||0); } }
          state.data[kind] = list.slice().sort((a,b)=>{
            const ta = totalMap.get(a.name)||0; const tb = totalMap.get(b.name)||0;
            if(tb!==ta) return tb - ta;
            return String(a.name||'').localeCompare(String(b.name||''));
          });
        }catch(__){}
      }
      await Promise.allSettled([sortByTotals('dns'), sortByTotals('wg'), sortByTotals('apn')]);
      renderPage();
    }
    initDatasets();
    // --- User account logic ---
    (function(){
      const isLocal = /^(localhost|127\.0\.0\.1)/.test(location.hostname);
      const statusEl = document.getElementById('accStatus');
      const balRow = document.getElementById('u_balance_row');
      const balVal = document.getElementById('u_balance_value');
      const chatEl = document.getElementById('u_chat_id');
      const sendBtn = document.getElementById('u_send');
      const otpRow = document.getElementById('u_otp_row');
      const otpEl = document.getElementById('u_otp');
      const verifyBtn = document.getElementById('u_verify');
      const loggedRow = document.getElementById('u_logged');
      const logoutBtn = document.getElementById('u_logout');
      const histWrap = document.getElementById('u_history_wrap');
      const histList = document.getElementById('u_history');
      const openBtn = document.getElementById('openSignup');
      const openLabel = document.getElementById('openSignupLabel');
      const tgRow = document.getElementById('u_tg_row');
      const chatRow = document.getElementById('u_chat_row');
      const tgHint = document.getElementById('u_tg_hint');
      const idRow = document.getElementById('u_id_row');
      const idVal = document.getElementById('u_id_value');

      async function loadMe(session){
        if(!session) return;
        try{
          const r = await fetch('/auth/me', { headers:{ 'Authorization': `Bearer ${session}` } });
          if(r.ok){
            const { chat_id } = await r.json();
            if(idVal) idVal.textContent = chat_id || '';
          } else {
            if(idVal) idVal.textContent = '';
          }
        }catch(_){ if(idVal) idVal.textContent=''; }
        // Load balance
        try{
          const rb = await fetch('/user/balance', { headers:{ 'Authorization': `Bearer ${session}` } });
          if(rb.ok){
            const { balance } = await rb.json();
            if(balVal) balVal.textContent = `$${balance}`;
            if(balRow) balRow.style.display='flex';
          } else {
            if(balRow) balRow.style.display='none';
          }
        }catch(_e){ if(balRow) balRow.style.display='none'; }
      }

      async function renderLogged(){
        const ses = localStorage.getItem('userSession');
        if(ses){
          loggedRow.style.display='flex';
          otpRow.style.display='none';
          histWrap.style.display='block';
          if(openLabel){ openLabel.textContent = 'Dashboard'; }
          // hide onboarding rows when logged in
          if(tgRow) tgRow.style.display='none';
          if(chatRow) chatRow.style.display='none';
          if(tgHint) tgHint.style.display='none';
          if(idRow) idRow.style.display='flex';
          await loadMe(ses);
        } else {
          loggedRow.style.display='none';
          histWrap.style.display='none';
          if(openLabel){ openLabel.textContent = 'Create Account'; }
          // show onboarding rows when logged out
          if(tgRow) tgRow.style.display='flex';
          if(chatRow) chatRow.style.display='flex';
          if(tgHint) tgHint.style.display='block';
          if(idRow) idRow.style.display='none';
          if(idVal) idVal.textContent = '';
          if(balRow) balRow.style.display='none';
        }
      }

      (async()=>{
        try{
          if(isLocal){
            statusEl.textContent = 'Local mode';
            statusEl.style.color = '#ffd27a';
          } else {
            const r = await fetch('/status');
            if(r.ok){
              const {kv, bot} = await r.json();
              statusEl.textContent = `KV: ${kv? 'Connected':'Not available'} | Bot token: ${bot? 'Configured':'Missing'}`;
              statusEl.style.color = kv && bot ? '#9cff9c' : '#ffd27a';
            } else {
              statusEl.textContent = 'Unable to read status endpoint';
              statusEl.style.color = '#ffd27a';
            }
          }
        }catch(e){
          statusEl.textContent = 'Status check failed';
          statusEl.style.color = '#ffd27a';
        }
        renderLogged();
      })();

      // Prefill chat id from localStorage
      chatEl.value = localStorage.getItem('userChatId') || '';

      sendBtn.addEventListener('click', async (e)=>{
        e.preventDefault();
        const chat_id = chatEl.value.trim();
        if(!chat_id) return window.showError('Enter ID');
        localStorage.setItem('userChatId', chat_id);
        if(isLocal){
          window.showError('In local mode, sending the code may not work. Please test again after deployment.');
        }
        try{
          const r = await fetch('/auth/send-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id})});
            if(r.ok){
              const {next_retry_sec=30} = await r.json().catch(()=>({}));
              otpRow.style.display='flex';
              verifyBtn.style.display='inline-block';
              sendBtn.disabled = true; let left = next_retry_sec||30; const original = sendBtn.getAttribute('data-original-label') || sendBtn.textContent || 'Send Code';
              const t = setInterval(()=>{ left--; if(left<=0){clearInterval(t); sendBtn.disabled=false; sendBtn.textContent=original;} else { sendBtn.textContent=`${original} (${left} seconds left)`; } },1000);
            } else {
            const j = await r.json().catch(()=>({}));
            if(r.status===429 && j.next_retry_sec){
              window.showError(`Please wait ${j.next_retry_sec} seconds.`, 'لطفاً صبر کنید');
              } else {
              window.showError('Error sending code');
              }
            }
        }catch(e){ window.showError('Network error'); }
      });

      verifyBtn.addEventListener('click', async (e)=>{
        const chat_id = chatEl.value.trim();
        const code = otpEl.value.trim();
        if(!code) { window.showError('Enter code'); return; }
        try{
          const r = await fetch('/auth/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id,code})});
          if(r.ok){
            const {session} = await r.json();
            localStorage.setItem('userSession', session);
            window.showMessage('Your account has been verified.','پیام');
            await renderLogged();
          } else {
            window.showError('Verification failed');
          }
        }catch(e){ window.showError('Network error'); }
      });

      // style logout button and add confirmation
      logoutBtn.classList.add('danger-btn');
      logoutBtn.addEventListener('click', async ()=>{
        if(await window.showConfirm('آیا از خروج از حساب اطمینان دارید؟','تایید خروج')){
          localStorage.removeItem('userSession');
          await renderLogged();
        }
      });

      // Render user address history
      window.renderUserHistory = async function(){
        try{
          const arr = JSON.parse(localStorage.getItem('userAddrHistory') || '[]');
          histList.innerHTML = '';
          if(arr.length===0){
            const p = document.createElement('div');
            p.className = 'muted';
            p.textContent = 'No addresses fetched yet.';
            histList.appendChild(p);
            return;
          }
          for(const item of arr){
            const row = document.createElement('div');
            row.className = 'hist-row';
            const header = document.createElement('div');
            header.className = 'hist-header';
            header.textContent = `${item.country} — ${item.count} IPs`;
            const actions = document.createElement('div');
            const copy = document.createElement('button');
            copy.textContent = 'Copy';
            copy.addEventListener('click', async ()=>{
              try{ await navigator.clipboard.writeText((item.addresses||[]).join('\n')); }catch(_e){}
            });
            actions.appendChild(copy);
            const top = document.createElement('div');
            top.className = 'hist-top';
            top.appendChild(header);
            top.appendChild(actions);
            row.appendChild(top);

            // Geolocate up to first 8 IPs from this entry
            const ips = (item.addresses||[]).slice(0,8);
            if(ips.length){
              try{
                const r = await fetch('/geo', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ips }) });
                if(r.ok){
                  const { results=[] } = await r.json();
                  const list = document.createElement('div');
                  list.className = 'hist-geo-list';
                  for(const g of results){
                    const card = document.createElement('div');
                    card.className = 'hist-geo-card';
                    const ip = document.createElement('div'); ip.className = 'geo-ip'; ip.textContent = g.query || '';
                    const meta = document.createElement('div'); meta.className = 'geo-meta';
                    const parts = [];
                    if(g.countryCode){ parts.push(g.countryCode); }
                    if(g.city){ parts.push(g.city); }
                    if(g.isp){ parts.push(g.isp); }
                    meta.textContent = parts.join(' • ');
                    card.appendChild(ip);
                    card.appendChild(meta);
                    list.appendChild(card);
                  }
                  row.appendChild(list);
                }
              }catch(_e){}
            }
            histList.appendChild(row);
          }
        }catch(e){ histList.innerHTML=''; }
      }
    })();

    // --- Modal open/close for account panel ---
    (function(){
      const openBtn = document.getElementById('openSignup');
      const overlay = document.getElementById('accOverlay');
      const modal = document.getElementById('accModal');
      const closeBtn = document.getElementById('closeSignup');

      function open(){ overlay.classList.add('active'); modal.classList.add('active'); if(window.renderUserHistory) window.renderUserHistory(); }
      function close(){ overlay.classList.remove('active'); modal.classList.remove('active'); }
      window.openSignupModal = open;
      window.closeSignupModal = close;

      if(openBtn) openBtn.addEventListener('click', open);
      if(closeBtn) closeBtn.addEventListener('click', close);
      if(overlay) overlay.addEventListener('click', close);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();
    // Mobile menu modal functionality
    (function(){
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const mobileMenuModal = document.getElementById('mobile-menu-modal');
      const mobileMenuClose = document.getElementById('mobile-menu-close');
      const mobileMenuTabs = document.querySelectorAll('.mobile-menu-modal .tab');
      
      function openModal(){
        mobileMenuModal.classList.add('active');
        mobileMenuToggle.classList.add('active');
      }
      
      function closeModal(){
        mobileMenuModal.classList.remove('active');
        mobileMenuToggle.classList.remove('active');
      }
      
      // Open modal when toggle is clicked
      if(mobileMenuToggle){
        mobileMenuToggle.addEventListener('click', openModal);
      }
      
      // Close modal when close button is clicked
      if(mobileMenuClose){
        mobileMenuClose.addEventListener('click', closeModal);
      }
      
      // Close modal when clicking outside content
      if(mobileMenuModal){
        mobileMenuModal.addEventListener('click', function(e){
          if(e.target === mobileMenuModal){
            closeModal();
          }
        });
      }
      
      // Handle tab selection in modal
      mobileMenuTabs.forEach(tab => {
        tab.addEventListener('click', function(){
          const tabType = this.getAttribute('data-tab');
          const tabText = this.textContent.trim();
          
          // Update active state in modal
          mobileMenuTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Update main tabs and trigger the actual tab functionality
          const mainTabs = document.querySelectorAll('.tabs .tab-list .tab');
          mainTabs.forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
          });
          
          // Find and activate the corresponding main tab
          const targetTab = document.getElementById(`tab-${tabType}`);
          if(targetTab){
            targetTab.classList.add('active');
            targetTab.setAttribute('aria-selected', 'true');
            // Trigger the actual tab click to switch content
            targetTab.click();
          }
          
          // Update toggle button text
          mobileMenuToggle.querySelector('span').textContent = tabText;
          
          // Close modal
          closeModal();
        });
      });
      
      // Close modal on escape key
      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape' && mobileMenuModal.classList.contains('active')){
          closeModal();
        }
      });
    })();

    // Tabs & Pagination wiring
    (function(){
      const tabDns = document.getElementById('tab-dns');
      const tabWg = document.getElementById('tab-wg');
      const tabApn = document.getElementById('tab-apn');
      const tabAndroid = document.getElementById('tab-android');
      const tabIos = document.getElementById('tab-ios');
      const prev = document.getElementById('prevPage');
      const next = document.getElementById('nextPage');
      const cards = document.getElementById('cards');
      const tabsWrap = document.querySelector('.tabs');

      async function animateSwitch(fn){
        if(cards){
          cards.classList.add('fade-out');
          await new Promise(r=>setTimeout(r, 160));
        }
        try{ fn && fn(); }catch(_e){}
        if(cards){
          // trigger next frame for smoother transition
          requestAnimationFrame(()=>{
            cards.classList.remove('fade-out');
            cards.classList.add('fade-in');
            setTimeout(()=> cards.classList.remove('fade-in'), 260);
          });
        }
      }

      function setActive(tab){
        animateSwitch(()=>{
          state.currentTab = tab;
          // persist active tab
          try{ localStorage.setItem('ui.currentTab', tab); }catch(_){}
          // Update all tab states
          const allTabs = [tabDns, tabWg, tabApn, tabAndroid, tabIos];
          allTabs.forEach(t => {
            if(t){
              t.classList.remove('active');
              t.setAttribute('aria-selected','false');
            }
          });
          
          // Set active tab
          if(tab==='dns' && tabDns){ tabDns.classList.add('active'); tabDns.setAttribute('aria-selected','true'); }
          else if(tab==='wg' && tabWg){ tabWg.classList.add('active'); tabWg.setAttribute('aria-selected','true'); }
          else if(tab==='apn' && tabApn){ tabApn.classList.add('active'); tabApn.setAttribute('aria-selected','true'); }
          else if(tab==='android' && tabAndroid){ tabAndroid.classList.add('active'); tabAndroid.setAttribute('aria-selected','true'); }
          else if(tab==='ios' && tabIos){ tabIos.classList.add('active'); tabIos.setAttribute('aria-selected','true'); }
          
          renderPage();
          // ensure active tab is visible on small screens
          try{ const active = document.querySelector('.tabs .tab.active'); if(active && tabsWrap){ active.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); } }catch(__){}
        });
      }
      if(tabDns) tabDns.addEventListener('click',()=> setActive('dns'));
      if(tabWg) tabWg.addEventListener('click',()=> setActive('wg'));
      if(tabApn) tabApn.addEventListener('click',()=> setActive('apn'));
      if(tabAndroid) tabAndroid.addEventListener('click',()=> setActive('android'));
      if(tabIos) tabIos.addEventListener('click',()=> setActive('ios'));
      // On load: make sure the default active tab is visible
      try{ const active = document.querySelector('.tabs .tab.active'); if(active && tabsWrap){ active.scrollIntoView({ behavior: 'auto', inline: 'center', block: 'nearest' }); } }catch(__){}
      function showComingSoon(kind){
        const titles = { apn: 'APN', android: 'Android Settings', ios: 'iPhone Settings' };
        const icons = {
          apn: '<img src="public/apn.svg" alt="" width="46" height="46" style="background:#fff;border-radius:50%;padding:4px"/>',
          android: '<img src="public/android.svg" alt="" width="46" height="46" style="background:#fff;border-radius:50%;padding:4px"/>',
          ios: '<img src="public/apple.svg" alt="" width="46" height="46" style="background:#fff;border-radius:50%;padding:4px"/>'
        };
        const msg = `<div style="display:flex;align-items:center;gap:.6rem;">${icons[kind]}<div><div style="font-weight:800">به زودی</div><div class="muted">این بخش در حال توسعه است و موقتا غیر فعال می‌باشد.</div></div></div>`;
        window.showMessage(msg, titles[kind]);
      }
      if(tabAndroid) tabAndroid.addEventListener('click', ()=> showComingSoon('android'));
      if(tabIos) tabIos.addEventListener('click', ()=> showComingSoon('ios'));
      if(prev) prev.addEventListener('click',()=>{
        animateSwitch(()=>{
          state.page[state.currentTab] = Math.max(1,(state.page[state.currentTab]||1)-1);
          renderPage();
        });
      });
      if(next) next.addEventListener('click',()=>{
        animateSwitch(()=>{
          const list = state.data[state.currentTab]||[];
          const total = Math.max(1, Math.ceil(list.length/pageSize));
          state.page[state.currentTab] = Math.min(total,(state.page[state.currentTab]||1)+1);
          renderPage();
        });
      });
      // Activate saved tab on load
      setTimeout(()=>{
        const initialTab = (localStorage.getItem('ui.currentTab')||'dns');
        if(initialTab && initialTab!== 'dns'){
          setActive(initialTab);
        } else {
          // ensure initial render uses saved page for default tab
          renderPage();
        }
      }, 0);
    })();
    </script>
  <script src="public/net.js"></script>
</body>
</html>
