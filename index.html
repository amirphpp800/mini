<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Countries Glass Cards</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&family=Vazirmatn:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="public/styles.css" />
</head>
<body>
  <canvas id="bg-net"></canvas>
  <header>
    <h1>Countries Showcase</h1>
    <a href="public/admin.html" class="admin-btn">Admin Panel</a>
    <div class="actions">
      <button id="openSignup" class="primary-btn">Create Account</button>
    </div>
  </header>
  <div class="modal-overlay" id="accOverlay"></div>
  <div class="modal-container" id="accModal">
    <section id="account" class="account-panel" role="dialog" aria-modal="true" aria-labelledby="accTitle">
      <button class="modal-close" id="closeSignup" aria-label="Close">×</button>
      <h2 id="accTitle">User Account</h2>
      <div class="status-line" id="accStatus">Checking status...</div>
      <div class="row">
        <a class="tg-btn" href="tg://resolve?domain=minidnsverify_bot">Start Telegram Bot</a>
      </div>
      <div class="row">
        <input type="number" id="u_chat_id" placeholder="Telegram chat_id" />
        <button id="u_send">Send Code</button>
      </div>
      <div class="row" id="u_otp_row" style="display:none">
        <input type="number" id="u_otp" placeholder="Enter verification code" />
        <button id="u_verify">Verify</button>
      </div>
      <div class="row" id="u_logged" style="display:none">
        <span>Logged in</span>
        <button id="u_logout">Logout</button>
      </div>
      <div id="u_history_wrap" style="display:none; margin-top: .75rem;">
        <div class="lbl" style="margin:.25rem 0">Your fetched addresses</div>
        <div id="u_history" style="display:flex;flex-direction:column;gap:.5rem;"></div>
      </div>
      <small>If you didn’t receive a message, open the Telegram bot below, press Start, then try again:
        <a href="https://t.me/minidnsverify_bot" target="_blank" rel="noopener" style="color:#7fd1ff">@minidnsverify_bot</a>
      </small>
    </section>
  </div>
  <!-- Global glassy error modal -->
  <div class="alert-overlay" id="alertOverlay"></div>
  <div class="alert-container" id="alertContainer">
    <div class="alert-card" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
      <div class="hdr">
        <div class="ttl" id="alertTitle">خطا</div>
        <button class="btn-close" id="alertX">×</button>
      </div>
      <div class="msg" id="alertMsg"></div>
      <div class="actions">
        <button class="btn-close" id="alertOk">باشه</button>
      </div>
    </div>
  </div>
  <main id="cards"></main>
  <script>
    // --- Error modal helper ---
    (function(){
      const overlay = document.getElementById('alertOverlay');
      const container = document.getElementById('alertContainer');
      const titleEl = document.getElementById('alertTitle');
      const msgEl = document.getElementById('alertMsg');
      const okBtn = document.getElementById('alertOk');
      const xBtn = document.getElementById('alertX');
      function close(){ overlay.classList.remove('active'); container.classList.remove('active'); }
      function showError(message, title){
        titleEl.textContent = title || 'خطا';
        msgEl.textContent = message || '';
        overlay.classList.add('active');
        container.classList.add('active');
      }
      okBtn.addEventListener('click', close);
      xBtn.addEventListener('click', close);
      overlay.addEventListener('click', close);
      window.showError = showError;
    })();
    // simple mapper to Persian names
    function nameToFa(name){
      const map = {
        'england': 'انگلیس',
        'united kingdom': 'بریتانیا',
        'uk': 'بریتانیا',
        'great britain': 'بریتانیا'
      };
      const key = String(name||'').toLowerCase();
      return map[key] || '';
    }
    const isLocal = /^(localhost|127\.0\.0\.1)/.test(location.hostname);
    async function loadCountries() {
      try {
        let data;
        // Always try dynamic endpoint first, then fallback to local file in both local and production
        try {
          const res = await fetch('/countries');
          if (res.ok) {
            data = await res.json();
          } else {
            throw new Error('fallback to local');
          }
        } catch (e) {
          const resLocal = await fetch('public/countries.json');
          data = await resLocal.json();
        }
        const container = document.getElementById('cards');
        container.innerHTML = '';
        data.forEach(c => {
          const card = document.createElement('div');
          card.className = 'glass-card';

          // Flag element: use FlagCDN with ISO 3166-1 alpha-2 code
          const code = String((c && c.code) || '').toLowerCase() || 'gb';
          const img = new Image();
          img.alt = `${c.name} flag`;
          img.loading = 'lazy';
          img.src = `https://flagcdn.com/w160/${code}.png`;
          img.srcset = `https://flagcdn.com/w320/${code}.png 2x`;
          img.referrerPolicy = 'no-referrer';
          img.className = 'flag-img';
          card.appendChild(img);

          // Title (EN) and subtitle (FA)
          const title = document.createElement('h2');
          title.textContent = c.name || '';
          card.appendChild(title);
          const sub = document.createElement('div');
          sub.className = 'subtitle-fa';
          sub.textContent = c.faName || nameToFa(c.name) || '';
          if (sub.textContent) card.appendChild(sub);

          // Counters
          const counters = document.createElement('div');
          counters.className = 'counters';
          counters.innerHTML = `
              <div class="count total"><div class="num">0</div><div class="lbl-en">Total IPs</div></div>
              <div class="count free"><div class="num">0</div><div class="lbl-en">Free</div></div>
              <div class="count busy"><div class="num">0</div><div class="lbl-en">Busy</div></div>`;
          card.appendChild(counters);

          // Button
          const btn = document.createElement('button');
          btn.className = 'get-btn';
          btn.textContent = 'Get Addresses';
          btn.addEventListener('click', async ()=>{
            const session = localStorage.getItem('userSession');
            if(!session){
              // Open signup modal for smoother UX
              if (window.openSignupModal) window.openSignupModal();
              else window.showError('Please verify your account first.');
              return;
            }
            try{
              const r = await fetch(`/addresses/${(c.name||'').toLowerCase()}`,{
                headers:{ 'Authorization': `Bearer ${session}` }
              });
              if(!r.ok){
                if(r.status===401||r.status===403){
                  window.showError('Your session is invalid or unverified. Please verify again.');
                } else {
                  window.showError('Failed to fetch addresses');
                }
                return;
              }
              const { addresses=[] } = await r.json();
              if(addresses.length===0){
                window.showError('No addresses available yet.');
                return;
              }
              const text = addresses.join('\n');
              await navigator.clipboard.writeText(text).catch(()=>{});
              alert(`Copied ${addresses.length} addresses to clipboard.`);
              // Save to local history for the user
              try{
                const key = 'userAddrHistory';
                const hist = JSON.parse(localStorage.getItem(key) || '[]');
                const entry = { country: c.name, count: addresses.length, addresses, ts: Date.now() };
                hist.unshift(entry);
                // keep last 20 entries max
                localStorage.setItem(key, JSON.stringify(hist.slice(0,20)));
                if(window.renderUserHistory) window.renderUserHistory();
              }catch(_e){}
            }catch(e){
              console.error(e);
              window.showError('Network error while fetching addresses');
            }
          });
          card.appendChild(btn);

          container.appendChild(card);
          // fetch stats (skip in local static mode)
          async function loadStats(){
            try{
              if(isLocal) return; 
              const r=await fetch(`/stats/${c.name}`);
              if(r.ok){
                const s=await r.json();
                card.querySelector('.total .num').textContent=s.total;
                card.querySelector('.free .num').textContent=s.free;
                card.querySelector('.busy .num').textContent=s.busy;
              }
            }catch(e){}
          }
          loadStats();
          if(!isLocal) setInterval(loadStats,30000);
        });
      } catch (err) {
        console.error(err);
        // Fallback: show a default country card if everything fails
        const container = document.getElementById('cards');
        container.innerHTML = '';
        const fallback = { name:'England', faName:'انگلیس', code:'gb' };
        const card = document.createElement('div');
        card.className = 'glass-card';
        const code = 'gb';
        const img = new Image();
        img.alt = `${fallback.name} flag`;
        img.loading = 'lazy';
        img.src = `https://flagcdn.com/w160/${code}.png`;
        img.srcset = `https://flagcdn.com/w320/${code}.png 2x`;
        img.referrerPolicy = 'no-referrer';
        img.className = 'flag-img';
        card.appendChild(img);
        const h2=document.createElement('h2');h2.textContent=fallback.name;card.appendChild(h2);
        const sub=document.createElement('div');sub.className='subtitle-fa';sub.textContent=fallback.faName;card.appendChild(sub);
        container.appendChild(card);
      }
    }
    loadCountries();
    // --- User account logic ---
    (function(){
      const isLocal = /^(localhost|127\.0\.0\.1)/.test(location.hostname);
      const statusEl = document.getElementById('accStatus');
      const chatEl = document.getElementById('u_chat_id');
      const sendBtn = document.getElementById('u_send');
      const otpRow = document.getElementById('u_otp_row');
      const otpEl = document.getElementById('u_otp');
      const verifyBtn = document.getElementById('u_verify');
      const loggedRow = document.getElementById('u_logged');
      const logoutBtn = document.getElementById('u_logout');
      const histWrap = document.getElementById('u_history_wrap');
      const histList = document.getElementById('u_history');
      const openBtn = document.getElementById('openSignup');

      function renderLogged(){
        const ses = localStorage.getItem('userSession');
        if(ses){
          loggedRow.style.display='flex';
          otpRow.style.display='none';
          histWrap.style.display='block';
          if(openBtn){ openBtn.textContent = 'Dashboard'; }
        } else {
          loggedRow.style.display='none';
          histWrap.style.display='none';
          if(openBtn){ openBtn.textContent = 'Create Account'; }
        }
      }

      (async()=>{
        try{
          if(isLocal){
            statusEl.textContent = 'Local mode';
            statusEl.style.color = '#ffd27a';
          } else {
            const r = await fetch('/status');
            if(r.ok){
              const {kv, bot} = await r.json();
              statusEl.textContent = `KV: ${kv? 'Connected':'Not available'} | Bot token: ${bot? 'Configured':'Missing'}`;
              statusEl.style.color = kv && bot ? '#9cff9c' : '#ffd27a';
            } else {
              statusEl.textContent = 'Unable to read status endpoint';
              statusEl.style.color = '#ffd27a';
            }
          }
        }catch(e){
          statusEl.textContent = 'Status check failed';
          statusEl.style.color = '#ffd27a';
        }
        renderLogged();
      })();

      // Prefill chat id from localStorage
      chatEl.value = localStorage.getItem('userChatId') || '';

      sendBtn.addEventListener('click', async (e)=>{
        e.preventDefault();
        const chat_id = chatEl.value.trim();
        if(!chat_id) return window.showError('Enter chat_id');
        localStorage.setItem('userChatId', chat_id);
        if(isLocal){
          window.showError('In local mode, sending the code may not work. Please test again after deployment.');
        }
        try{
          const r = await fetch('/auth/send-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id})});
            if(r.ok){
              const {next_retry_sec=30} = await r.json().catch(()=>({}));
              otpRow.style.display='flex';
              verifyBtn.style.display='inline-block';
              sendBtn.disabled = true; let left = next_retry_sec||30; const original = sendBtn.getAttribute('data-original-label') || sendBtn.textContent || 'Send Code';
              const t = setInterval(()=>{ left--; if(left<=0){clearInterval(t); sendBtn.disabled=false; sendBtn.textContent=original;} else { sendBtn.textContent=`${original} (${left} seconds left)`; } },1000);
            } else {
            const j = await r.json().catch(()=>({}));
            if(r.status===429 && j.next_retry_sec){
              window.showError(`Please wait ${j.next_retry_sec} seconds.`, 'لطفاً صبر کنید');
              } else {
              window.showError('Error sending code');
              }
            }
        }catch(e){ window.showError('Network error'); }
      });

      verifyBtn.addEventListener('click', async (e)=>{
        const chat_id = chatEl.value.trim();
        const code = otpEl.value.trim();
        if(!code) { window.showError('Enter code'); return; }
        try{
          const r = await fetch('/auth/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id,code})});
          if(r.ok){
            const {session} = await r.json();
            localStorage.setItem('userSession', session);
            alert('Your account has been verified.');
            renderLogged();
          } else {
            window.showError('Verification failed');
          }
        }catch(e){ window.showError('Network error'); }
      });

      // style logout button and add confirmation
      logoutBtn.classList.add('danger-btn');
      logoutBtn.addEventListener('click', ()=>{
        if(confirm('آیا از خروج از حساب اطمینان دارید؟')){
          localStorage.removeItem('userSession');
          renderLogged();
        }
      });

      // Render user address history
      window.renderUserHistory = async function(){
        try{
          const arr = JSON.parse(localStorage.getItem('userAddrHistory') || '[]');
          histList.innerHTML = '';
          if(arr.length===0){
            const p = document.createElement('div');
            p.className = 'muted';
            p.textContent = 'No addresses fetched yet.';
            histList.appendChild(p);
            return;
          }
          for(const item of arr){
            const row = document.createElement('div');
            row.className = 'hist-row';
            const header = document.createElement('div');
            header.className = 'hist-header';
            header.textContent = `${item.country} — ${item.count} IPs`;
            const actions = document.createElement('div');
            const copy = document.createElement('button');
            copy.textContent = 'Copy';
            copy.addEventListener('click', async ()=>{
              try{ await navigator.clipboard.writeText((item.addresses||[]).join('\n')); }catch(_e){}
            });
            actions.appendChild(copy);
            const top = document.createElement('div');
            top.className = 'hist-top';
            top.appendChild(header);
            top.appendChild(actions);
            row.appendChild(top);

            // Geolocate up to first 8 IPs from this entry
            const ips = (item.addresses||[]).slice(0,8);
            if(ips.length){
              try{
                const r = await fetch('/geo', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ips }) });
                if(r.ok){
                  const { results=[] } = await r.json();
                  const list = document.createElement('div');
                  list.className = 'hist-geo-list';
                  for(const g of results){
                    const card = document.createElement('div');
                    card.className = 'hist-geo-card';
                    const ip = document.createElement('div'); ip.className = 'geo-ip'; ip.textContent = g.query || '';
                    const meta = document.createElement('div'); meta.className = 'geo-meta';
                    const parts = [];
                    if(g.countryCode){ parts.push(g.countryCode); }
                    if(g.city){ parts.push(g.city); }
                    if(g.isp){ parts.push(g.isp); }
                    meta.textContent = parts.join(' • ');
                    card.appendChild(ip);
                    card.appendChild(meta);
                    list.appendChild(card);
                  }
                  row.appendChild(list);
                }
              }catch(_e){}
            }
            histList.appendChild(row);
          }
        }catch(e){ histList.innerHTML=''; }
      }
    })();

    // --- Modal open/close for account panel ---
    (function(){
      const openBtn = document.getElementById('openSignup');
      const overlay = document.getElementById('accOverlay');
      const modal = document.getElementById('accModal');
      const closeBtn = document.getElementById('closeSignup');

      function open(){ overlay.classList.add('active'); modal.classList.add('active'); if(window.renderUserHistory) window.renderUserHistory(); }
      function close(){ overlay.classList.remove('active'); modal.classList.remove('active'); }
      window.openSignupModal = open;
      window.closeSignupModal = close;

      if(openBtn) openBtn.addEventListener('click', open);
      if(closeBtn) closeBtn.addEventListener('click', close);
      if(overlay) overlay.addEventListener('click', close);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();
    </script>
  <script src="public/net.js"></script>
</body>
</html>
